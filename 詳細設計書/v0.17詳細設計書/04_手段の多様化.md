# v0.17 詳細設計書：04_手段の多様化

## 0. 本資料の目的

- 各方針で使用可能な手段の詳細仕様を定義する
- 手段ごとの特性（リスク/コスト/能力依存/所要時間）を明確化する
- 成果計算式（基礎ゲージ量の算出方法）を整理する
- 既存コード（COMMANDS）との整合性を確保する

---

## 1. 手段の基本構造

### 1-1. 手段の定義

各手段は以下の要素で構成される：

```typescript
export interface ActionSpec {
    type: ActionType              // 手段の種類
    policy: PolicyType            // どの方針で使えるか
    baseGaugeGain: [number, number]  // 基礎ゲージ量（最小〜最大）
    cost: number                  // 費用（貫）
    riskLevel: 'low' | 'medium' | 'high'  // リスクレベル
    abilityDependency: 'combat' | 'intelligence' | 'administration' | 'command' | 'none'
    duration: number              // 所要ターン
    requireRank?: Rank            // 必要役職
    successRateBase?: number      // 基礎成功率（リスクがある手段のみ）
}
```

### 1-2. 手段の分類

手段は以下の3つの軸で分類される：

#### リスクレベル
- **low**：失敗がない、または失敗しても損失が小さい
- **medium**：失敗すると一定の損失がある
- **high**：失敗すると大きな損失がある

#### 能力依存
- **combat**：武芸能力に依存
- **intelligence**：知略能力に依存
- **administration**：政務能力に依存
- **command**：統率能力に依存
- **none**：能力に依存しない

#### コスト
- **0**：無料
- **0.1〜1.0**：少額
- **1.0〜5.0**：中額
- **5.0〜**：高額

---

## 2. 治安回復の手段

### 2-1. 巡察

| 項目 | 値 |
|------|-----|
| 手段名 | 巡察 |
| 基礎ゲージ量 | 5〜10 |
| コスト | 0 |
| リスクレベル | low |
| 能力依存 | none |
| 所要ターン | 1 |
| 必要役職 | なし |

#### 説明
- 領内を巡回し、治安状況を確認する
- 失敗がなく、安定した小幅増加
- 治安が良い状態でも実行可能

#### 成果計算式
```typescript
baseGauge = random(5, 10)
// 能力補正なし
finalGauge = baseGauge
```

#### 既存コードとの対応
- `COMMANDS.巡察` に対応（merit: 3）

### 2-2. 情報収集

| 項目 | 値 |
|------|-----|
| 手段名 | 情報収集 |
| 基礎ゲージ量 | 10〜20 |
| コスト | 0.5 |
| リスクレベル | low |
| 能力依存 | intelligence |
| 所要ターン | 1 |
| 必要役職 | なし |

#### 説明
- 盗賊の動向や住民の声を集める
- 知略能力が高いほど効率が良い
- 中程度の増加

#### 成果計算式
```typescript
baseGauge = random(10, 20)
abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- `COMMANDS.情報収集` に対応（merit: 5, expGain: intelligence +10）

### 2-3. 盗賊討伐

| 項目 | 値 |
|------|-----|
| 手段名 | 盗賊討伐 |
| 基礎ゲージ量 | 規模により変動 |
| コスト | 0 |
| リスクレベル | 規模により変動 |
| 能力依存 | combat |
| 所要ターン | 4 |
| 必要役職 | 規模により変動 |

#### 規模別の詳細

##### 小規模（D級）
- 基礎ゲージ量：15〜25
- リスクレベル：medium
- 必要役職：なし
- 基礎成功率：70%

##### 中規模（C級）
- 基礎ゲージ量：25〜40
- リスクレベル：medium
- 必要役職：なし
- 基礎成功率：60%

##### 大規模（B級）
- 基礎ゲージ量：40〜60
- リスクレベル：high
- 必要役職：馬上衆
- 基礎成功率：50%

##### 討伐戦（A級）
- 基礎ゲージ量：60〜80
- リスクレベル：high
- 必要役職：馬上衆
- 基礎成功率：40%

##### 賊軍（S級）
- 基礎ゲージ量：80〜100
- リスクレベル：high
- 必要役職：小頭
- 基礎成功率：30%

#### 成果計算式
```typescript
// 成功判定
successRate = baseSuccessRate + (player.combat - banditCombat) * 0.3
successRate = clamp(successRate, 5, 95)
success = random(0, 100) < successRate

if (success) {
    baseGauge = banditRankGaugeRange[0] + random(0, banditRankGaugeRange[1] - banditRankGaugeRange[0])
    abilityMultiplier = 0.8 + (player.combat / 100) * 0.4  // 0.8〜1.2
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0  // 失敗時はゲージ増加なし
}
```

#### 既存コードとの対応
- `COMMANDS['盗賊討伐（小規模）']` 〜 `COMMANDS['盗賊討伐（賊軍）']` に対応
- `BANDIT_RANKS` の設定を流用

---

## 3. 軍備増強の手段

### 3-1. 訓練

| 項目 | 値 |
|------|-----|
| 手段名 | 訓練 |
| 基礎ゲージ量 | 10〜20 |
| コスト | 0 |
| リスクレベル | low |
| 能力依存 | combat |
| 所要ターン | 1 |
| 必要役職 | なし |
| 目的ステータス | 士気 |

#### 説明
- 武芸の鍛錬を行い、足軽の士気を高める
- 安定した増加
- 訓練ゲージ100で士気+1

#### 成果計算式
```typescript
baseGauge = random(10, 20)
abilityMultiplier = 0.8 + (player.combat / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- `COMMANDS.訓練` に対応（merit: 5, expGain: combat +5）

### 3-2. 演習

| 項目 | 値 |
|------|-----|
| 手段名 | 演習 |
| 基礎ゲージ量 | 15〜25 |
| コスト | 0.5 |
| リスクレベル | low |
| 能力依存 | command |
| 所要ターン | 2 |
| 必要役職 | なし |
| 目的ステータス | 疲労上限 |

#### 説明
- 実戦形式の鍛錬を行い、疲労耐性を高める
- 統率能力が高いほど効率が良い
- 演習ゲージ100で疲労上限+1（最大120）

#### 成果計算式
```typescript
baseGauge = random(15, 25)
abilityMultiplier = 0.8 + (player.command / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 3-3. 装備整備

| 項目 | 値 |
|------|-----|
| 手段名 | 装備整備 |
| 基礎ゲージ量 | 10〜15 |
| コスト | 1.0 |
| リスクレベル | low |
| 能力依存 | administration |
| 所要ターン | 1 |
| 必要役職 | なし |
| 目的ステータス | 軍備充実度 |

#### 説明
- 既存装備を整える（維持・底上げ）
- 政務能力が高いほど効率が良い
- 装備整備ゲージ100で軍備充実度+1

#### 成果計算式
```typescript
baseGauge = random(10, 15)
abilityMultiplier = 0.8 + (player.administration / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 3-4. 城壁改修

| 項目 | 値 |
|------|-----|
| 手段名 | 城壁改修 |
| 基礎ゲージ量 | 20〜30 |
| コスト | 3.0 |
| リスクレベル | low |
| 能力依存 | administration |
| 所要ターン | 4 |
| 必要役職 | なし |
| 目的ステータス | 城防御力 |

#### 説明
- 城の守りを整える（政務寄り）
- 大きな増加だが時間とコストがかかる
- 城壁改修ゲージ100で城防御力+1

#### 成果計算式
```typescript
baseGauge = random(20, 30)
abilityMultiplier = 0.8 + (player.administration / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- 新規追加（v0.17）

---

## 4. 計略の手段

### 4-1. 敵情視察

| 項目 | 値 |
|------|-----|
| 手段名 | 敵情視察 |
| 基礎ゲージ量 | 10〜15 |
| コスト | 0.5 |
| リスクレベル | low |
| 能力依存 | intelligence |
| 所要ターン | 2 |
| 必要役職 | なし |
| 基礎成功率 | 80% |

#### 説明
- 敵の動向を探る
- 安定した増加
- 失敗しても一定の経験値は得られる

#### 成果計算式
```typescript
successRate = 80 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 60, 95)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(10, 15)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = random(5, 10)  // 失敗時も少量のゲージ
}
```

#### 既存コードとの対応
- `COMMANDS.賊軍偵察` に類似（expGain: intelligence +15）

### 4-2. 内通者への接触

| 項目 | 値 |
|------|-----|
| 手段名 | 内通者への接触 |
| 基礎ゲージ量 | 20〜30 |
| コスト | 2.0 |
| リスクレベル | medium |
| 能力依存 | intelligence |
| 所要ターン | 3 |
| 必要役職 | なし |
| 基礎成功率 | 60% |

#### 説明
- 敵内部に協力者を作る
- リスク・リターン中
- 失敗すると費用が無駄になる

#### 成果計算式
```typescript
successRate = 60 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 40, 85)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(20, 30)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0  // 失敗時はゲージ増加なし
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 4-3. 補給路の妨害

| 項目 | 値 |
|------|-----|
| 手段名 | 補給路の妨害 |
| 基礎ゲージ量 | 25〜35 |
| コスト | 1.5 |
| リスクレベル | medium |
| 能力依存 | intelligence |
| 所要ターン | 3 |
| 必要役職 | なし |
| 基礎成功率 | 55% |

#### 説明
- 敵の補給を妨害する
- リスク・リターン中
- 失敗すると費用が無駄になる

#### 成果計算式
```typescript
successRate = 55 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 35, 80)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(25, 35)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 4-4. 放火

| 項目 | 値 |
|------|-----|
| 手段名 | 放火 |
| 基礎ゲージ量 | 30〜50 |
| コスト | 2.5 |
| リスクレベル | high |
| 能力依存 | intelligence |
| 所要ターン | 4 |
| 必要役職 | 馬上衆 |
| 基礎成功率 | 45% |

#### 説明
- 敵の拠点に火を放つ
- 最高リスク・リターン
- 失敗すると費用が無駄になり、評判も下がる可能性

#### 成果計算式
```typescript
successRate = 45 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 25, 75)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(30, 50)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0
    // 将来：評判ペナルティを追加
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 4-5. 流言の流布

| 項目 | 値 |
|------|-----|
| 手段名 | 流言の流布 |
| 基礎ゲージ量 | 15〜25 |
| コスト | 1.0 |
| リスクレベル | medium |
| 能力依存 | intelligence |
| 所要ターン | 2 |
| 必要役職 | なし |
| 基礎成功率 | 65% |

#### 説明
- 敵の士気を下げる噂を流す
- 中程度の増加
- 失敗すると費用が無駄になる

#### 成果計算式
```typescript
successRate = 65 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 45, 85)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(15, 25)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

---

## 5. 手段の一覧表

### 5-1. 治安回復

| 手段 | ゲージ量 | コスト | リスク | 能力依存 | 所要ターン | 必要役職 |
|------|---------|--------|--------|---------|-----------|---------|
| 巡察 | 5〜10 | 0 | low | none | 1 | なし |
| 情報収集 | 10〜20 | 0.5 | low | intelligence | 1 | なし |
| 盗賊討伐（小） | 15〜25 | 0 | medium | combat | 4 | なし |
| 盗賊討伐（中） | 25〜40 | 0 | medium | combat | 4 | なし |
| 盗賊討伐（大） | 40〜60 | 0 | high | combat | 4 | 馬上衆 |
| 盗賊討伐（討伐戦） | 60〜80 | 0 | high | combat | 4 | 馬上衆 |
| 盗賊討伐（賊軍） | 80〜100 | 0 | high | combat | 8 | 小頭 |

### 5-2. 軍備増強

| 手段 | ゲージ量 | コスト | リスク | 能力依存 | 所要ターン | 必要役職 | 目的ステ |
|------|---------|--------|--------|---------|-----------|---------|---------|
| 訓練 | 10〜20 | 0 | low | combat | 1 | なし | 士気 |
| 演習 | 15〜25 | 0.5 | low | command | 2 | なし | 疲労上限 |
| 装備整備 | 10〜15 | 1.0 | low | administration | 1 | なし | 軍備充実度 |
| 城壁改修 | 20〜30 | 3.0 | low | administration | 4 | なし | 城防御力 |

### 5-3. 計略

| 手段 | ゲージ量 | コスト | リスク | 能力依存 | 所要ターン | 必要役職 |
|------|---------|--------|--------|---------|-----------|---------|
| 敵情視察 | 10〜15 | 0.5 | low | intelligence | 2 | なし |
| 内通者への接触 | 20〜30 | 2.0 | medium | intelligence | 3 | なし |
| 補給路の妨害 | 25〜35 | 1.5 | medium | intelligence | 3 | なし |
| 放火 | 30〜50 | 2.5 | high | intelligence | 4 | 馬上衆 |
| 流言の流布 | 15〜25 | 1.0 | medium | intelligence | 2 | なし |

---

## 6. 実装上の注意点

### 6-1. 定数の追加（constants/game.ts）

```typescript
// 手段の特性
export const ACTION_SPECS: Record<ActionType, ActionSpec> = {
    // 治安回復
    '巡察': {
        type: '巡察',
        policy: '治安回復',
        baseGaugeGain: [5, 10],
        cost: 0,
        riskLevel: 'low',
        abilityDependency: 'none',
        duration: 1,
    },
    '情報収集': {
        type: '情報収集',
        policy: '治安回復',
        baseGaugeGain: [10, 20],
        cost: 0.5,
        riskLevel: 'low',
        abilityDependency: 'intelligence',
        duration: 1,
    },
    // ... 他の手段も同様に定義
}

// 能力補正の計算
export function getAbilityMultiplier(
    player: PlayerState,
    abilityType: 'combat' | 'intelligence' | 'administration' | 'command' | 'none'
): number {
    if (abilityType === 'none') return 1.0
    
    const abilityValue = player.stats[abilityType]
    return 0.8 + (abilityValue / 100) * 0.4  // 0.8〜1.2
}
```

### 6-2. ゲージ加算処理の実装

```typescript
// 手段を実行してゲージを加算
function executeAction(
    actionType: ActionType,
    player: PlayerState,
    state: GameState
): void {
    const spec = ACTION_SPECS[actionType]
    
    // コストを支払う
    if (player.money < spec.cost) {
        // エラー処理
        return
    }
    player.money -= spec.cost
    
    // 成功判定（リスクがある手段のみ）
    let success = true
    if (spec.successRateBase !== undefined) {
        const successRate = calculateSuccessRate(spec, player)
        success = Math.random() * 100 < successRate
    }
    
    // 基礎ゲージ量を決定
    let baseGauge = 0
    if (success) {
        baseGauge = randomInt(spec.baseGaugeGain[0], spec.baseGaugeGain[1])
    } else {
        // 失敗時の処理（手段により異なる）
        baseGauge = getFailureGauge(actionType)
    }
    
    // 能力補正を適用
    const abilityMultiplier = getAbilityMultiplier(player, spec.abilityDependency)
    const finalGauge = Math.floor(baseGauge * abilityMultiplier)
    
    // 進捗度による逓減倍率を適用（03_進捗ゲージ.md参照）
    const progressMultiplier = getGaugeMultiplier(
        state.currentPolicy.progress,
        POLICY_CONFIG[state.currentPolicy.type].gaugeMultiplierTable
    )
    const adjustedGauge = Math.floor(finalGauge * progressMultiplier)
    
    // 手段ゲージに加算
    addMeansGauge(actionType, adjustedGauge, state)
}
```

### 6-3. 既存COMMANDSとの統合

既存の `COMMANDS` は維持しつつ、v0.17では `ACTION_SPECS` を優先的に使用する。

```typescript
// 既存のCOMMANDSから手段情報を取得する互換関数
function getActionFromCommand(commandType: CommandType): ActionSpec | null {
    // v0.17の手段として定義されている場合
    if (ACTION_SPECS[commandType]) {
        return ACTION_SPECS[commandType]
    }
    
    // 既存のCOMMANDSから変換
    const command = COMMANDS[commandType]
    if (!command) return null
    
    // COMMANDSの情報をActionSpecに変換
    return convertCommandToAction(command)
}
```

---

## 7. 将来拡張（v0.18以降）

### 7-1. 手段の追加

- **募兵**：人脈・供給システム実装後に追加
- **装備調達**：人脈・供給システム実装後に追加
- **外交工作**：外交システム実装後に追加

### 7-2. 手段の組み合わせ

- 複数の手段を組み合わせることで、相乗効果を発揮
- 例：情報収集 → 盗賊討伐で成功率アップ

### 7-3. 手段の熟練度

- 同じ手段を繰り返すことで、熟練度が上がり効率が向上
- ただし、逓減メカニズムとのバランスが必要

---

## 8. テスト観点

### 8-1. 手段の実行

- [ ] 各手段が正しく実行されるか
- [ ] コストが正しく支払われるか
- [ ] 必要役職のチェックが機能するか

### 8-2. ゲージ加算

- [ ] 基礎ゲージ量が正しく計算されるか
- [ ] 能力補正が正しく適用されるか
- [ ] 進捗度による逓減倍率が正しく適用されるか

### 8-3. 成功判定

- [ ] リスクのある手段で成功判定が機能するか
- [ ] 失敗時の処理が正しく動作するか
- [ ] 成功率の計算が正しいか

### 8-4. 既存コードとの整合性

- [ ] 既存のCOMMANDSとの互換性が保たれているか
- [ ] 盗賊討伐の戦闘システムが正しく動作するか
- [ ] 経験値獲得が正しく機能するか
