# v0.17 詳細設計書：06_評価システム

## 0. 本資料の目的

- 3段階評価（平凡/優秀/卓越）の仕組みを定義する
- ライバル比較の仕組みを整理する
- 評価に応じた報酬を設計する

---

## 1. 評価システムの概要

### 1-1. 評価のタイミング

評価は**評定時（4ターン周期）**に実行される：

- ターン1, 5, 9, 13, ... で評定が開催
- 現在の方針の達成度を評価
- 評価結果に応じて報酬を付与
- 新しい方針を発行

### 1-2. 評価の基準

評価は**方針の進捗度（progress）**に基づいて判定される：

| 評価 | 条件 | 説明 |
|------|------|------|
| 卓越 | progress ≥ excellentProgress | 期待を大きく上回る成果 |
| 優秀 | progress ≥ challengeProgress | 期待を上回る成果 |
| 平凡 | progress ≥ targetProgress | 最低限の目標を達成 |
| 未達 | progress < targetProgress | 目標未達 |

---

## 2. 評価の詳細

### 2-1. 治安回復の評価基準

| 評価 | 治安度 | 説明 |
|------|--------|------|
| 卓越 | 95以上 | 領内がほぼ完全に平定された |
| 優秀 | 80以上 | 治安が大幅に改善された |
| 平凡 | 60以上 | 最低限の目標を達成 |
| 未達 | 60未満 | 治安が改善されなかった |

### 2-2. 軍備増強の評価基準

| 評価 | 軍備充実度 | 説明 |
|------|-----------|------|
| 卓越 | 95以上 | 軍備がほぼ完璧に整った |
| 優秀 | 80以上 | 軍備が大幅に強化された |
| 平凡 | 60以上 | 最低限の目標を達成 |
| 未達 | 60未満 | 軍備が整わなかった |

### 2-3. 計略の評価基準

| 評価 | 計略成果 | 説明 |
|------|---------|------|
| 卓越 | 60以上 | 敵を大幅に弱体化させた |
| 優秀 | 40以上 | 敵を十分に弱体化させた |
| 平凡 | 20以上 | 最低限の成果を上げた |
| 未達 | 20未満 | 成果が不十分だった |

---

## 3. 評価に応じた報酬

### 3-1. 功績（merit）の倍率

評価に応じて、功績の倍率が変わる：

| 評価 | 功績倍率 | 説明 |
|------|---------|------|
| 卓越 | ×2.0 | 功績が2倍 |
| 優秀 | ×1.5 | 功績が1.5倍 |
| 平凡 | ×1.0 | 功績が等倍 |
| 未達 | ×0.6 | 功績が0.6倍（ペナルティ） |

### 3-2. 扶持米のボーナス

卓越評価の場合、扶持米のボーナスが付与される：

| 評価 | 扶持米ボーナス | 説明 |
|------|--------------|------|
| 卓越 | +0.5石 | 月額扶持米が0.5石増加 |
| 優秀 | なし | - |
| 平凡 | なし | - |
| 未達 | なし | - |

### 3-3. 評判の変化（将来実装）

評価に応じて、評判が変化する（v0.17では設計のみ）：

| 評価 | 評判変化 | 説明 |
|------|---------|------|
| 卓越 | +10 | 評判が大幅に上昇 |
| 優秀 | +5 | 評判が上昇 |
| 平凡 | 0 | 変化なし |
| 未達 | -5 | 評判が低下 |

---

## 4. ライバル比較

### 4-1. ライバルの行動

ライバルも同じ方針を受けており、同じ期間で進捗を進める：

- ライバルの進捗は**AIによって自動計算**される
- ライバルの能力値と行動パターンに応じて進捗が決まる

### 4-2. ライバルの進捗計算

```typescript
function calculateRivalProgress(
    rival: RivalState,
    policy: PolicyState,
    turns: number
): number {
    // ライバルの基礎効率
    const baseEfficiency = getRivalBaseEfficiency(rival.behavior)
    
    // 能力値による補正
    const abilityMultiplier = getRivalAbilityMultiplier(rival, policy.type)
    
    // ターン数による進捗
    const progressPerTurn = baseEfficiency * abilityMultiplier
    const totalProgress = progressPerTurn * turns
    
    // ランダム要素（±20%）
    const randomFactor = 0.8 + Math.random() * 0.4
    
    return Math.floor(totalProgress * randomFactor)
}
```

### 4-3. ライバルの基礎効率

| 行動パターン | 基礎効率 | 説明 |
|------------|---------|------|
| safe | 3〜5 / turn | 安全志向、低リスク・低リターン |
| balanced | 5〜8 / turn | バランス型、中リスク・中リターン |
| aggressive | 7〜12 / turn | 攻撃的、高リスク・高リターン |

### 4-4. ライバル比較の表示

評定時に、プレイヤーとライバルの進捗を比較して表示：

| プレイヤー進捗 | ライバル進捗 | 結果 | メッセージ |
|--------------|------------|------|-----------|
| 80 | 60 | 勝利 | 「ライバルを大きく引き離した！」 |
| 70 | 65 | 僅差で勝利 | 「ライバルをわずかに上回った」 |
| 60 | 60 | 引き分け | 「ライバルと同等の成果だった」 |
| 55 | 65 | 僅差で敗北 | 「ライバルにわずかに及ばなかった」 |
| 40 | 70 | 敗北 | 「ライバルに大きく引き離された...」 |

**注意**：ライバル比較は**誉め言葉のみ**で、報酬には影響しない。

---

## 5. 評価画面の設計

### 5-1. 評価画面の構成

評定時に表示される評価画面は、以下の要素で構成される：

1. **方針の種類**：治安回復/軍備増強/計略
2. **達成度**：進捗度（progress）と目標値
3. **評価結果**：卓越/優秀/平凡/未達
4. **報酬**：功績、扶持米ボーナス
5. **ライバル比較**：プレイヤーとライバルの進捗比較
6. **上司のコメント**：評価に応じたコメント

### 5-2. 上司のコメント

評価に応じて、上司からのコメントが表示される：

#### 卓越
- 「見事である！期待を大きく上回る働きであった」
- 「これほどの成果を上げるとは...恐れ入った」
- 「お前の働きには目を見張るものがある」

#### 優秀
- 「よくやった。期待以上の成果だ」
- 「なかなかの働きぶりだ」
- 「この調子で励むように」

#### 平凡
- 「まあ、及第点というところか」
- 「最低限の務めは果たしたな」
- 「次はもう少し励むように」

#### 未達
- 「これでは話にならぬ」
- 「次は必ず目標を達成せよ」
- 「このままでは昇進は望めぬぞ」

---

## 6. 実装

### 6-1. 評価処理

```typescript
function evaluatePolicy(policy: PolicyState): EvaluationResult {
    let rank: 'excellent' | 'good' | 'normal' | 'failed'
    
    if (policy.progress >= policy.excellentProgress) {
        rank = 'excellent'
    } else if (policy.progress >= policy.challengeProgress) {
        rank = 'good'
    } else if (policy.progress >= policy.targetProgress) {
        rank = 'normal'
    } else {
        rank = 'failed'
    }
    
    // 報酬を計算
    const meritMultiplier = EVALUATION_CONFIG[rank].meritMultiplier
    const bonusRice = EVALUATION_CONFIG[rank].bonusRice
    
    return {
        rank,
        meritMultiplier,
        bonusRice,
        comment: getEvaluationComment(rank),
    }
}
```

### 6-2. 報酬の付与

```typescript
function applyEvaluationRewards(
    player: PlayerState,
    evaluation: EvaluationResult,
    baseMerit: number
): void {
    // 功績を付与
    const merit = Math.floor(baseMerit * evaluation.meritMultiplier)
    player.merit += merit
    
    // 扶持米ボーナスを付与（卓越のみ）
    if (evaluation.bonusRice > 0) {
        player.rice += evaluation.bonusRice
    }
}
```

### 6-3. ライバル比較

```typescript
function compareWithRival(
    playerProgress: number,
    rivalProgress: number
): RivalComparisonResult {
    const diff = playerProgress - rivalProgress
    
    if (diff >= 20) {
        return {
            result: 'big_win',
            message: 'ライバルを大きく引き離した！',
        }
    } else if (diff >= 5) {
        return {
            result: 'win',
            message: 'ライバルをわずかに上回った',
        }
    } else if (diff >= -5) {
        return {
            result: 'draw',
            message: 'ライバルと同等の成果だった',
        }
    } else if (diff >= -20) {
        return {
            result: 'lose',
            message: 'ライバルにわずかに及ばなかった',
        }
    } else {
        return {
            result: 'big_lose',
            message: 'ライバルに大きく引き離された...',
        }
    }
}
```

---

## 7. 定数

### 7-1. 評価設定

```typescript
export const EVALUATION_CONFIG = {
    excellent: {
        meritMultiplier: 2.0,
        bonusRice: 0.5,
    },
    good: {
        meritMultiplier: 1.5,
        bonusRice: 0,
    },
    normal: {
        meritMultiplier: 1.0,
        bonusRice: 0,
    },
    failed: {
        meritMultiplier: 0.6,
        bonusRice: 0,
    },
}
```

### 7-2. ライバルの基礎効率

```typescript
export const RIVAL_BASE_EFFICIENCY = {
    safe: [3, 5],       // 3〜5 / turn
    balanced: [5, 8],   // 5〜8 / turn
    aggressive: [7, 12], // 7〜12 / turn
}
```

---

## 8. テスト観点

### 8-1. 評価判定

- [ ] 進捗度に応じて正しく評価されるか
- [ ] 卓越/優秀/平凡/未達の判定が正しいか

### 8-2. 報酬付与

- [ ] 功績の倍率が正しく適用されるか
- [ ] 扶持米ボーナスが正しく付与されるか（卓越のみ）

### 8-3. ライバル比較

- [ ] ライバルの進捗が正しく計算されるか
- [ ] ライバル比較の結果が正しく表示されるか
- [ ] ライバル比較が報酬に影響しないか

### 8-4. 評価画面

- [ ] 評価画面が正しく表示されるか
- [ ] 上司のコメントが正しく表示されるか
