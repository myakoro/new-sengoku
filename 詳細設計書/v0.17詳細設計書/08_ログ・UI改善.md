# v0.17 詳細設計書：08_ログ・UI改善

## 0. 本資料の目的

- 行動理由/結果理由のログ出力を設計する
- 進捗ゲージのデザインを整理する
- 命令伝達の表示デザインを定義する（4段階カスケード）

---

## 1. ログ改善

### 1-1. 現状の問題点

v0.15のログは、行動の結果のみを表示しており、**なぜその行動を選んだのか**が分からない：

```
ターン5：盗賊討伐（中規模）を実行
→ 成功！功績+30
```

### 1-2. 改善方針

行動の**理由**と**結果の詳細**を表示する：

```
ターン5：巡察（豪華）を実行
理由：治安回復の方針を進めるため（警備力強化）
→ 成功！警備力ゲージ+14（予算を投じて成果を底上げ）
→ 予算消費：0.3貫（残：4.2貫 / 計画的消費）
→ 状況：周囲の警戒を徹底し、不穏な動きを未然に防いだ。
```

### 1-3. ログの構造

```typescript
export interface ActionLog {
    turn: number                    // ターン数
    actionType: ActionType          // 行動の種類
    reason: string                  // 行動の理由
    result: ActionResult            // 結果
    details: string[]               // 詳細情報
}

export interface ActionResult {
    success: boolean                // 成功/失敗
    gaugeGain: number               // ゲージ増加量
    progressGain: number            // 進捗増加量
    meritGain: number               // 功績増加量
    expGain: Record<string, number> // 経験値増加量
}
```

### 1-4. ログの例

#### 例1：訓練
```
ターン3：訓練（豪華）を実行
理由：軍備増強の方針を進めるため（目標：手段ゲージ+10）
→ 成功！訓練（手段ゲージ）+15（豪華アプローチ×1.5適用）
→ 予算消費：0.75貫（残：2.25貫 / 予算残に注意）
→ 武芸経験値+5
```

#### 例2：盗賊討伐（成功）
```
ターン7：盗賊討伐（中規模）を実行
理由：治安回復の方針を進めるため（平穏度強化。要：盗賊カード）
→ 成功！討伐ゲージ+30
→ 平穏度+1（40→41）、功績+30
→ 公費消費：0貫（残：3.0貫）
→ 武芸経験値+20
```

#### 例3：盗賊討伐（失敗）
```
ターン11：盗賊討伐（大規模）を実行
理由：治安回復の方針を進めるため（目標：治安度60以上）
→ 失敗...敵の戦闘力が高すぎた
→ ゲージ増加なし、功績+0
→ 武芸経験値+5（失敗時も少量獲得）
```

#### 例4：情報収集
```
ターン2：情報収集を実行
理由：治安回復の方針を進めるため（情報網強化）
→ 成功！情報収集ゲージ+15（知略補正×1.1適用）
→ 公費消費：0.5貫（残：4.0貫）
→ 成果：小規模な盗賊の隠れ家を発見！「盗賊カード（D）」獲得
→ 知略経験値+10

#### 例5：戦闘前鼓舞演説
```
ターン12：戦闘前鼓舞演説を実行
理由：総攻撃に向けた最終的な士気高揚のため（攻撃直前限定・退路遮断）
→ 成功！全軍の士気+5、攻撃力+5
→ 状況：指揮官の熱き言葉により、全軍が死力を尽くす覚悟を決めた。
→ 注意：これ以降の準備変更・追加は不可。最終決断へ移行する。
```

---

## 2. 進捗ゲージのデザイン

### 2-1. 表示位置

MainScreen の上部に、現在の方針と進捗ゲージを表示：

```
┌─────────────────────────────────────┐
│ 現在の方針：治安回復                │
│ 期限：ターン13まで（残り8ターン）   │
│ 部隊予算（残）：4.0貫 / 10.0貫      │
│                                     │
│ 治安度（平均）：41 / 60（最低目標） │
│ ■■■■■■■□□□□□□□□ 41%    │
│                                     │
│ ├ 警備力（ステ）：50 ■■■■■□□□□□   │
│ ├ 情報網（ステ）：33 ■■■□□□□□□□   │
│ └ 平穏度（ステ）：40 ■■■■□□□□□□   │
└─────────────────────────────────────┘
```

### 2-2. ゲージの色分け

進捗度に応じて、ゲージの色を変える：

| 進捗度 | 色 | 説明 |
|--------|-----|------|
| 0〜39% | 赤 | 目標未達の危険 |
| 40〜59% | 黄 | 最低目標に近い |
| 60〜79% | 緑 | 最低目標達成 |
| 80〜94% | 青 | 優秀評価圏内 |
| 95〜100% | 金 | 卓越評価圏内 |

### 2-3. 目標値の表示

役職により、目標値の表示が異なる：

#### 徒士/馬上衆
```
治安度：41 / ???（目標不明）
■■■■■■■□□□□□□□□ 41%
```

#### 軍団長（Gundancho）・部隊長（Butaicho）および上位役職者
```
治安度：41 / 60（最低目標）
■■■■■■■□□□□□□□□ 41%

目標：60（平凡）/ 80（優秀）/ 95（卓越）
```

---

## 3. 命令伝達の表示デザイン

### 3-1. 表示位置

MainScreen の中央に、命令伝達の内容を表示：

```
┌─────────────────────────────────────┐
│ 【下知】                            │
│                                     │
│ 羽柴様より、今月は治安回復に努めよ │
│ との命があった。                    │
│                                     │
│ （中評定担当の場合）                  │
│ 治安数値を月末までに60まで回復させ │
│ ること。現在は40である。            │
└─────────────────────────────────────┘
```

### 3-2. 小評定（第3段）の表示デザイン
徒士・馬上衆（プレイヤー）が直接対面する、現場レベルの命令画面。

#### A: 評定・命令（ターン1：月次表彰あり）
月初めの評定では、先月の「番付（ランキング）」が発表され、上位者が公に褒め称えられる。

```
┌─────────────────────────────────────┐
│ 【小評定：月次番付発表】            │
│                                     │
│ 「先月の働き、誠に見事であった。    │
│ 　これより特に秀でた者の名を読み上げる」│
│                                     │
│ １位：[ライバルA]（卓越）          │
│ ２位：[プレイヤー]（卓越）          │
│ ３位：[若党B]    （優秀）          │
│                                     │
│ 「１位の[ライバルA]には、殿より    │
│ 　特に褒美の[アイテム名/金]を遣わす」│
│                                     │
│ [ 次へ（命令受領へ） ]              │
└─────────────────────────────────────┘
```

#### B: 評定・命令（ターン5：通常下知のみ）
中旬の評定では、儀式を省略し、速やかに次の4ターンの任が下される。

```
┌─────────────────────────────────────┐
│ 【小評定：命令受領】                │
│                                     │
│ 「休む間もなく次の任を与える。      │
│ 　[プレイヤー名]、貴殿はこれを。    │
│                                     │
│ ├ 担当する手段：訓練                │
│ ├ 完遂ノルマ　：10 手段ゲージ / 4T  │
│ └ 委託予算　　：0.5 貫              │
│                                     │
│ [ 承知した ]                        │
└─────────────────────────────────────┘
```

#### C: 成果報告時（ターン4, 8, 12...）
4ターンの活動結果を上司に報告し、ROI（投資対効果）も含めた暫定的な評価を受ける。

```
┌─────────────────────────────────────┐
│ 【小評定：成果報告】                │
│                                     │
│ 担当手段：訓練                      │
│                                     │
│ ├ 達成ゲージ　：12 / 10 (120%)      │
│ ├ 消費予算　　：0.5 貫 / 0.5 貫     │
│ └ 実績ROI 　　：24.0                │
│                                     │
│ 評価：【優秀】                      │
│                                     │
│ 「よくやった。予算を使い切りノルマを│
│ 　超えるとは、見事な精進だ」        │
│                                     │
│ 獲得功績：+15                       │
│                                     │
│ [ 次の2週間へ ]                     │
└─────────────────────────────────────┘
```

---

## 4. UI改善の詳細

### 4-1. MainScreen のレイアウト

```
┌─────────────────────────────────────┐
│ 【方針と進捗】                      │
│ 現在の方針：治安回復                │
│ 期限：ターン13まで（残り8ターン）   │
│ 治安度：41 / 60（最低目標）         │
│ ■■■■■■■□□□□□□□□ 41%    │
├─────────────────────────────────────┤
│ 【下知ノルマ】                      │
│ 担当：巡察                          │
│ ゲージ：25 / 45  [■■■■□□□□]  33%       │
│ 予算：0.4 / 0.8貫 [■■■■■■□□]  50%       │
├─────────────────────────────────────┤
│ 【状態】                            │
│ ターン：5 / 週：3                   │
│ 役職：徒士                          │
│ 功績：120 / 250（馬上衆まで）       │
│ 扶持米：1.5石 / 月                  │
│ 所持金：5.2貫                       │
│ 借金：8.0貫（月利5%）               │
├─────────────────────────────────────┤
│ 【コマンド】                        │
│ 1. 訓練                             │
│ 2. 巡察                             │
│ 3. 情報収集                         │
│ 4. 盗賊討伐                         │
│ 5. その他                           │
└─────────────────────────────────────┘
```

### 4-2. コマンド選択画面

```
┌─────────────────────────────────────┐
│ 【コマンド選択：情報収集】          │
│                                     │
│ アプローチを選択してください：      │
│                                     │
│ 1. 愚直（0貫）                      │
│    成果：0.7〜1.0倍 / ROI重視       │
│                                     │
│ 2. 並（0.5貫）                      │
│    成果：1.0〜1.3倍 / 標準          │
│                                     │
│ 3. 豪華（0.75貫）                   │
│    成果：1.4〜1.6倍 / 速度重視      │
│                                     │
│ 4. 戻る                             │
└─────────────────────────────────────┘
```

### 4-3. 評定画面

```
┌─────────────────────────────────────┐
│ 【評定】                            │
│                                     │
│ 方針：治安回復                      │
│ 期間：ターン1〜13                   │
│                                     │
│ 【達成度】                          │
│ 治安度：65 / 60（最低目標）         │
│ ■■■■■■■■■■■□□□□ 65%    │
│                                     │
│ 【評価】                            │
│ 優秀！                              │
│                                     │
│ 【報酬】                            │
│ 功績：+45（基礎30 × 倍率1.5）       │
│                                     │
│ 【上司のコメント】                  │
│ 「よくやった。期待以上の成果だ」   │
│                                     │
│ 【ライバル比較】                    │
│ あなた：65                          │
│ ライバル：60                        │
│ → ライバルをわずかに上回った       │
└─────────────────────────────────────┘
```

### 4-4. 戦闘画面（決戦・追撃）のレイアウト

より臨場感のある「手前・奥」のレイヤー構造を導入します。

```
┌─────────────────────────────────────┐
│ 【盗賊討伐：第5ターン / 残り19】    │
│                                     │
│ [ 背景：薄暗い森の街道 ]           │
│                                     │
│    （奥：敵勢力）                   │
│      [ 盗賊A ] [ 盗賊B ] [ 盗賊C ]  │
│      ■■■□□  ■■□□□  ■■■■□  │
│                                     │
│          ↑ (交戦)                  │
│                                     │
│    （手前：自軍）                   │
│   [ 若党X ] [ 主人公 ] [ 若党Y ]    │
│   ■■■■■  ■■■■■  ■■■■■    │
│                                     │
├─────────────────────────────────────┤
│ 【コマンド】                        │
│ 1. 突撃（攻撃重視スタンス）         │
│ 2. 統率（鼓舞：士気回復）           │
│ 3. 交代（控えと入れ替え）           │
│ 4. 撤退                             │
└─────────────────────────────────────┘
```

### 4-5. ユニット戦闘：準備フェーズのUI（スキルツリー）

盗賊討伐の下知時に発生する準備フェーズでは、アクションの依存関係を視覚化したツリーUIを導入する。

#### UI仕様
1. **ノード表示**: 
   - 未開放アクション：暗灰色（ロックアイコン表示）
   - 実行可能アクション：通常色（各ステータス、所要T、担当枠を表示）
   - 完了済みアクション：明るい縁取り（チェックマーク表示）
2. **依存線**: 
   - 「詳細偵察」と「地形調査」から各計画（夜襲・火計・全体作戦）への合流を実線で表示。
3. **担当者割当**: 各ノードにマウスオーバー/タップで担当候補（本人・若党）の能力値と成功率予測をポップアップ表示。

#### 戦闘前鼓舞演説の特殊演出
- **最終フェーズ移行**: 演説アクションを決定した瞬間、画面全体のトーンが「決意の赤」に変化。
- **UIロック**: ツリーの他ノードが「UNAVAILABLE（変更不可）」として網掛け表示し、ターン進行ボタンを「演説と共に突撃」という特殊ボタンに変更する。

---

## 5. 実装

### 5-1. ログ出力

```typescript
function logAction(
    turn: number,
    actionType: ActionType,
    reason: string,
    result: ActionResult
): void {
    const log: ActionLog = {
        turn,
        actionType,
        reason,
        result,
        details: generateDetails(result),
    }
    
    // ログに追加
    gameState.logs.push(log)
    
    // コンソールに出力
    console.log(`ターン${turn}：${actionType}を実行`)
    console.log(`理由：${reason}`)
    console.log(`→ ${result.success ? '成功！' : '失敗...'}`)
    log.details.forEach(detail => console.log(`→ ${detail}`))
}

function generateDetails(result: ActionResult): string[] {
    const details: string[] = []
    
    if (result.gaugeGain > 0) {
        details.push(`ゲージ+${result.gaugeGain}`)
    }
    
    if (result.progressGain > 0) {
        details.push(`進捗+${result.progressGain}`)
    }
    
    if (result.meritGain > 0) {
        details.push(`功績+${result.meritGain}`)
    }
    
    Object.entries(result.expGain).forEach(([stat, gain]) => {
        details.push(`${stat}経験値+${gain}`)
    })
    
    return details
}
```

### 5-2. 進捗ゲージの表示

```typescript
function renderProgressGauge(
    current: number,
    target: number,
    showTarget: boolean
): JSX.Element {
    const percentage = Math.min(100, (current / target) * 100)
    const color = getGaugeColor(percentage)
    
    return (
        <div className="progress-gauge">
            <div className="progress-label">
                {current} / {showTarget ? target : '???'}
            </div>
            <div className="progress-bar">
                <div 
                    className={`progress-fill ${color}`}
                    style={{ width: `${percentage}%` }}
                />
            </div>
            <div className="progress-percentage">
                {Math.floor(percentage)}%
            </div>
        </div>
    )
}

function getGaugeColor(percentage: number): string {
    if (percentage >= 95) return 'gold'
    if (percentage >= 80) return 'blue'
    if (percentage >= 60) return 'green'
    if (percentage >= 40) return 'yellow'
    return 'red'
}
```

---

## 6. テスト観点

### 6-1. ログ出力

- [ ] 行動の理由が正しく表示されるか
- [ ] 結果の詳細が正しく表示されるか
- [ ] 成功/失敗が正しく表示されるか

### 6-2. 進捗ゲージ

- [ ] 進捗度が正しく表示されるか
- [ ] ゲージの色が正しく変わるか
- [ ] 役職による目標値の表示/非表示が正しいか

### 6-3. 命令伝達

- [ ] 役職による表示内容の違いが正しいか
- [ ] 4段階の命令が正しく表示されるか

### 6-4. UI全体

- [ ] レイアウトが見やすいか
- [ ] 情報が整理されているか
- [ ] 操作しやすいか
