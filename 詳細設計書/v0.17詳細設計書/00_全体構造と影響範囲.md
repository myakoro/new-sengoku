# v0.17 詳細設計書：全体構造と影響範囲

## 0. 本資料の目的

v0.17の実装時に参照する前提資料。
既存コード（v0.15）のどこを、どのように変更するかを整理する。

---

## 1. v0.17の変更概要

### 1-1. 大きな変更点

| 変更内容 | 影響度 | 概要 |
|----------|--------|------|
| 方針システムの導入 | 大 | 「盗賊討伐固定」→「3方針（治安回復/軍備増強/計略）」に全面置換 |
| 命令伝達の3段階化 | 大 | MandateStateを拡張し、大・中・小評定の階層を表現 |
| 進捗ゲージの導入 | 大 | 方針に対する進捗を数値で管理・表示 |
| 手段の多様化 | 中 | 同じ方針に対し複数の手段を選択可能に |
| 評価システムの拡張 | 中 | 3段階評価（平凡/優秀/卓越）＋ライバル競争 |
| 成果計算の変更 | 中 | 能力×ランダム係数、討伐は敵規模依存 |

### 1-2. 維持する部分

- 基本的なゲームループ（週進行、評定周期）
- 戦闘システムの基盤（BanditBattleState等）
- 借金システム
- 若党/足軽/馬上衆の管理
- セーブ/ロード機能

---

## 2. 既存コードの影響箇所

### 2-1. 型定義（types/game.ts）

#### 削除/置換する型

```typescript
// 現在のMandateState（削除予定）
export interface MandateState {
    target: CommandType           // ← 「盗賊討伐」固定になっている
    issuedTurn: number
    dueTurn: number
    successMerit: number
    status: 'active' | 'succeeded' | 'failed'
    fixedStartTurn?: number
    fixedDuration?: number
}
```

#### 新規追加する型

```typescript
// 方針の種類
export type PolicyType = '治安回復' | '軍備増強' | '計略'

// 方針の状態
export interface PolicyState {
    type: PolicyType
    issuedTurn: number           // 発行ターン
    dueTurn: number              // 期限ターン
    progress: number             // 現在の進捗（0〜100）
    gauge: number                // 手段ゲージ（0〜100、100で進捗+1）
    meritGauge: number           // 方針ゲージ（手柄の目安）
    targetProgress: number       // 最低目標（例：60）
    challengeProgress: number    // 挑戦目標（例：80）
    excellentProgress: number    // 卓越目標（例：95）
    status: 'active' | 'succeeded' | 'failed'
}

// 命令伝達の3段階
export interface MandateChain {
    // 第1段：大評定（Why / 方針）
    grandEvaluation: {
        policy: PolicyType
        targetPoints: number
        budget: number
    }
    // 第2段：中評定（What / ROI指標）
    midEvaluation: {
        roiMetric: string
        allocatedBudget: number
        deadline: number
    }
    // 第3段：小評定（How / 手段ノルマ）
    smallEvaluation: {
        action: ActionType
        quota: number
        entrustedBudget: number
    }
}

// 手段の種類（方針ごとに異なる）
export type ActionType =
    // 治安回復
    | '巡察' | '情報収集' | '盗賊討伐'
    // 軍備増強
    | '訓練' | '装備整備' | '演習' | '城壁改修'
    // 計略
    | '敵情視察' | '内通者への接触' | '補給路の妨害' | '放火' | '流言の流布'

// 手段の特性
export interface ActionSpec {
    type: ActionType
    policy: PolicyType           // どの方針で使えるか
    progressGain: [number, number]  // 進捗増加量（最小〜最大）
    cost: number                 // 費用
    riskLevel: 'low' | 'medium' | 'high'
    abilityDependency: 'combat' | 'intelligence' | 'administration' | 'none'
    duration: number             // 所要ターン
}
```

#### 変更する型

```typescript
// CommandType（拡張）
export type CommandType =
    | '訓練'
    | '全体訓練'
    | '巡察'
    | '情報収集'
    | '護衛任務'
    | '賊軍偵察'
    | '盗賊討伐（小規模）'
    | '盗賊討伐（中規模）'
    | '盗賊討伐（大規模）'
    | '盗賊討伐（討伐戦）'
    | '盗賊討伐（賊軍）'
    // v0.17追加
    | '装備整備'
    | '演習'
    | '城壁改修'
    | '敵情視察'
    | '内通者への接触'
    | '補給路の妨害'
    | '放火'
    | '流言の流布'
```

### 2-2. 状態管理（store/gameStore.ts）

#### 削除/置換する関数

```typescript
// 現在のgenerateMandateForPlayer（削除予定）
// → 「盗賊討伐固定」になっているため、方針システムに置換
function generateMandateForPlayer(player: PlayerState): MandateState | null {
    if (player.rank === '小頭') return null
    const target: CommandType = player.rank === '徒士' ? '盗賊討伐（小規模）' : '盗賊討伐（中規模）'
    // ...
}
```

#### 新規追加する状態

```typescript
interface GameState {
    // 既存
    player: PlayerState | null
    rival: RivalState | null
    // ...

    // v0.17追加
    currentPolicy: PolicyState | null      // 現在の方針
    mandateChain: MandateChain | null      // 命令伝達の3段階
    
    // v0.17追加アクション
    generateNewPolicy: () => void          // 新しい方針を生成
    addGauge: (baseAmount: number) => void  // ゲージを加算（100で進捗+1）
    selectAction: (action: ActionType) => void  // 手段を選択
    evaluatePolicy: () => 'excellent' | 'good' | 'normal' | 'failed'  // 方針の評価
}
```

#### 変更する関数

```typescript
// advanceWeek（変更）
// - 方針の切り替え判定を追加
// - 進捗ゲージの更新を追加
// - 状況変化（盗賊の移動/強化等）を追加

// issueNextMandate（置換）
// → generateNewPolicy に置換
```

### 2-3. 画面（screens/）

#### MainScreen.tsx

| 変更箇所 | 内容 |
|----------|------|
| 下知表示部分 | 「盗賊討伐」固定 → 方針＋4段階命令伝達の表示 |
| 進捗表示 | 新規追加：進捗ゲージ（現在値/目標値） |
| コマンド選択 | 方針に応じた手段リストを表示 |

#### CommandSelectScreen.tsx

| 変更箇所 | 内容 |
|----------|------|
| コマンドリスト | 方針に応じた手段のみ表示 |
| 手段の特性表示 | 安全性/コスト/効率/能力依存を表示 |

#### 新規追加画面

| 画面名 | 内容 |
|--------|------|
| PolicyScreen.tsx | 方針の詳細表示（4段階命令伝達の全文） |
| EvaluationScreen.tsx | 評定画面の拡張（3段階評価＋ライバル比較） |

### 2-4. 定数（constants/game.ts）

#### 削除/置換する定数

```typescript
// COMMANDS（一部置換）
// - 盗賊討伐系は残す（手段の一つとして使用）
// - 方針システム用の手段定数を追加
```

#### 新規追加する定数

```typescript
// 方針の設定
export const POLICY_CONFIG: Record<PolicyType, {
    actions: ActionType[]
    baseTargetProgress: number
    challengeBonus: number
    excellentBonus: number
}> = {
    '治安回復': {
        actions: ['巡察', '情報収集', '盗賊討伐'],
        baseTargetProgress: 60,
        challengeBonus: 20,
        excellentBonus: 35,
    },
    '軍備増強': {
        actions: ['訓練', '装備整備', '演習', '城壁改修'],
        baseTargetProgress: 60,
        challengeBonus: 20,
        excellentBonus: 35,
    },
    '計略': {
        actions: ['敵情視察', '内通者への接触', '補給路の妨害', '放火', '流言の流布'],
        baseTargetProgress: 50,
        challengeBonus: 20,
        excellentBonus: 30,
    },
}

// 手段の特性
export const ACTION_SPECS: Record<ActionType, ActionSpec> = {
    '巡察': {
        type: '巡察',
        policy: '治安回復',
        progressGain: [5, 10],
        cost: 0,
        riskLevel: 'low',
        abilityDependency: 'none',
        duration: 1,
    },
    // ... 他の手段も同様に定義
}

// 評価の閾値と報酬
export const EVALUATION_CONFIG = {
    excellent: { meritMultiplier: 2.0, bonusRice: 0.5 },
    good: { meritMultiplier: 1.5, bonusRice: 0 },
    normal: { meritMultiplier: 1.0, bonusRice: 0 },
    failed: { meritMultiplier: 0.6, bonusRice: 0 },
}

---

## 3. 実装順序（Phase別）

### Phase 1（最優先）

1. **型定義の追加**（types/game.ts）
   - PolicyType, PolicyState（`progress` + `gauge`）
   - MandateChain
   - ActionType, ActionSpec

2. **定数の追加**（constants/game.ts）
   - POLICY_CONFIG（方針別の手段リスト、ゲージ倍率等）
   - ACTION_SPECS（手段ごとの成果・能力依存・リスク）
   - EVALUATION_CONFIG（評価と報酬）

3. **状態管理の変更**（store/gameStore.ts）
   - `currentPolicy`, `mandateChain` の追加
   - `generateNewPolicy`, `addGauge` の追加
   - `advanceWeek` の変更（評定/方針切替、状況変化）

4. **MainScreenの変更**
   - 方針表示、進捗（治安度など）＋ゲージ表示

### Phase 2

5. **手段の多様化**
   - 方針に応じた手段リストの提示
   - 手段ごとの成果（ゲージ加算）の適用

6. **準備システム**
   - 準備と実行のトレードオフ
   - 状況変化ロジック（放置や偏りへの反作用）

### Phase 3

7. **評価システム**
   - 3段階評価（平凡/優秀/卓越）
   - ライバル比較

8. **昇進システム改善**
   - 資源制約の調整
   - 借金システムとの連携強化

### Phase 4

9. **ログ改善**
   - 行動理由/結果理由の出力

10. **UI調整**
    - 進捗ゲージのデザイン
    - 命令伝達の表示デザイン

---

## 4. 既存機能との整合性

### 4-1. 盗賊討伐の位置づけ

- v0.15：下知（mandate）として固定で発生
- v0.17：「治安回復」方針の**手段の一つ**として発生
  - 盗賊カード（banditCards）の仕組みは維持
  - 戦闘システム（BanditBattleState）は維持
  - 討伐成功時に進捗ゲージが増加する形に変更

### 4-2. 評定周期

- v0.15：4ターン周期（1,5,9,...）で評定
- v0.17：同じ周期を維持
  - 評定時に方針の達成度を判定
  - 新しい方針を発行

### 4-3. ライバル

- v0.15：功績を比較するだけ
- v0.17：同じ方針に対する進捗を比較
  - ライバルも同じ方針を受けている設定
  - 進捗の比較で「勝ち/負け」を表示（報酬なし、誉め言葉のみ）

---

## 5. 移行時の注意点

### 5-1. セーブデータの互換性

- v0.15のセーブデータはv0.17で読み込めなくなる可能性
- 対応案：
  - A) セーブデータのバージョンチェックを追加し、旧データは新規ゲーム扱い
  - B) マイグレーション処理を実装（mandate → currentPolicy への変換）

### 5-2. テスト観点

- 方針の切り替えが正しく動作するか
- 進捗ゲージが正しく増減するか
- 評定時の評価が正しく計算されるか
- 役職による見え方の違いが正しく表示されるか

---

## 6. 次のステップ

この資料を前提に、以下の詳細設計書を順次作成する：

1. `01_方針システム.md` - 方針の生成/切り替え/状態管理
2. `02_命令伝達システム.md` - 4段階の文面生成/表示ロジック
3. `03_進捗ゲージ.md` - 計算式/表示/評定連携
4. `04_手段の多様化.md` - 手段一覧/特性/成果計算
5. `05_準備システム.md` - トレードオフ/状況変化
6. `06_評価システム.md` - 3段階評価/ライバル/報酬
7. `07_昇進システム改善.md` - 資源制約/借金連携
8. `08_ログ・UI改善.md` - ログ改善/UI調整
