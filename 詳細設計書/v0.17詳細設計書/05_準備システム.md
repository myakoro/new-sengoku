# v0.17 詳細設計書：05_準備システム

## 0. 本資料の目的

- 準備と実行のトレードオフを設計する
- 状況変化ロジック（放置や偏りへの反作用）を定義する
- 「クリック連打最適」を防ぐメカニズムを整理する

---

## 1. 準備システムの概要

### 1-1. 基本コンセプト

「準備なしで実行すると効率が悪い」「準備に時間をかけすぎると実行時間が減る」というトレードオフを設計する。

### 1-2. 設計方針

- **準備フェーズ**：情報収集、計画立案、資源確保など
- **実行フェーズ**：実際の行動（盗賊討伐、訓練、計略など）
- **準備度**：準備フェーズでどれだけ準備したかを示す指標（0〜100）
- **効率補正**：準備度が高いほど、実行フェーズの効率が上がる

---

## 2. 準備度の仕組み

### 2-1. 準備度の定義

```typescript
export interface PreparationState {
    level: number           // 準備度（0〜100）
    type: ActionType        // 何の準備をしているか
    turnsSpent: number      // 準備に費やしたターン数
    maxTurns: number        // 最大準備ターン数
}
```

### 2-2. 準備度の上昇

準備フェーズで以下の行動を実行すると、準備度が上昇する：

| 準備行動 | 準備度上昇量 | 対象手段 |
|---------|------------|---------|
| 情報収集 | +20〜30 | 盗賊討伐 |
| 敵情視察 | +15〜25 | 計略全般 |
| 装備点検 | +10〜20 | 訓練、演習 |
| 資金調達 | +10〜15 | コストのかかる手段 |

### 2-3. 準備度による効率補正

実行フェーズで手段を実行する際、準備度に応じて効率補正がかかる：

```typescript
function getPreparationMultiplier(preparationLevel: number): number {
    // 準備度0: ×0.6（効率60%）
    // 準備度50: ×1.0（効率100%）
    // 準備度100: ×1.4（効率140%）
    return 0.6 + (preparationLevel / 100) * 0.8
}
```

### 2-4. 準備度の減衰

準備度は時間経過とともに減衰する：

- **1ターン経過ごと**：準備度 -5
- **実行後**：準備度 -50（実行後は準備が消費される）

---

## 3. 準備と実行のトレードオフ

### 3-1. 時間配分の最適化

プレイヤーは限られた時間（例：8ターン）の中で、準備と実行のバランスを取る必要がある。

#### 戦略1：愚直（能力・ROI重視）
- アプローチ：愚直
- 効率：×0.7〜0.9
- コスト：0貫
- **ROI**：最高。能力が高いプレイヤーが手柄を稼ぐのに最適。

#### 戦略2：並（バランス重視）
- アプローチ：並
- 効率：×1.0
- コスト：標準
- **ROI**：標準。安定した進捗と予算消費のバランスが良い。

#### 戦略3：豪華（速度・時間重視）
- アプローチ：豪華
- 効率：×1.5
- コスト：1.5倍
- **ROI**：低め。期限が迫っている場合や、能力が不足している場合に資金で進捗を補う。

### 3-2. 最適戦略の例

8ターンの期間で盗賊討伐（所要4ターン）を実行する場合：

#### 戦略A：準備なし
- ターン1〜4：盗賊討伐（準備度0、効率×0.6）
- ターン5〜8：盗賊討伐（準備度0、効率×0.6）
- **総ゲージ**：(30 × 0.6) + (30 × 0.6) = 36

#### 戦略B：1ターン準備
- ターン1：情報収集（準備度+25）
- ターン2〜5：盗賊討伐（準備度25、効率×0.8）
- ターン6：情報収集（準備度+25、減衰-20=30）
- ターン7〜8：（時間不足）
- **総ゲージ**：30 × 0.8 = 24

#### 戦略C：2ターン準備
- ターン1〜2：情報収集×2（準備度+50）
- ターン3〜6：盗賊討伐（準備度50、効率×1.0）
- ターン7〜8：（時間不足）
- **総ゲージ**：30 × 1.0 = 30

#### 戦略D：バランス型
- ターン1：情報収集（準備度+25）
- ターン2〜5：盗賊討伐（準備度25→20、効率×0.76）
- ターン6〜7：情報収集×2（準備度+50）
- ターン8：（時間不足）
- **総ゲージ**：30 × 0.76 = 22.8

**結論**：準備なしで連打が最も効率が良い場合がある → **調整が必要**

---

## 4. 状況変化ロジック

### 4-1. 目的

「同じ手段ばかり繰り返す」「放置する」ことへの反作用として、状況が変化する仕組みを導入する。

### 4-2. 治安回復の状況変化（反作用）

#### 平穏度の自然減衰と警備力
治安維持を怠ると、平穏度は時間とともに低下する。
- **メカニズム**：毎ターン、固定値（例：-1）の減衰判定。
- **警備力の影響**：警備力が高いほど、この減衰の発生率または減少量が抑制される（よく見回りしているため、不穏な動きが広まりにくい）。

#### 盗賊の発生・強化と警備力
- **発生**：警備力が低いと、領外から新規の盗賊（カード）が流入しやすくなる。
- **強化**：既に存在する盗賊カードを放置すると、一定ターンごとにランクが上昇する可能性がある。

#### 情報網による発見と防御
- **発見**：情報網が高いほど、「巡察」や「情報収集」時の盗賊カード発見率にボーナスがかかる。
- **計略防御**：他勢力からの計略（流言、放火など）を受けた際、情報網を防御力として参照し、成功率を減衰させる。

#### 平穏度の恩恵（将来拡張）
- **生産力バフ**：平穏度が高い状態が維持されると、村や町の生産性（米・金の収入）にプラスの補正がかかる。

### 4-3. 軍備増強の状況変化

#### 装備の劣化

プレイヤーが装備整備を放置すると、装備が劣化する：

- **放置ターン数**：装備整備を実行しないターン数
- **変化条件**：放置ターン数が16ターン（2ヶ月）を超える
- **変化内容**：
  - 軍備充実度が低下（-5〜10）
  - 訓練・演習の効率が低下（×0.9）

#### 士気の低下

プレイヤーが訓練を放置すると、士気が低下する：

- **放置ターン数**：訓練を実行しないターン数
- **変化条件**：放置ターン数が12ターン（1.5ヶ月）を超える
- **変化内容**：
  - 士気が低下（-5〜10）

### 4-4. 計略の状況変化

#### 敵の警戒度上昇

プレイヤーが計略を連続で実行すると、敵の警戒度が上昇する：

- **連続実行回数**：直近4ターンでの計略実行回数
- **変化条件**：連続実行回数が3回以上
- **変化内容**：
  - 計略の成功率が低下（-10〜20%）
  - 計略の効率が低下（×0.8）

#### 警戒度の減衰

計略を実行しない期間が続くと、警戒度が減衰する：

- **放置ターン数**：計略を実行しないターン数
- **変化条件**：放置ターン数が4ターン以上
- **変化内容**：
  - 警戒度が減衰（-10〜20）
  - 計略の成功率が回復

---

## 5. 準備システムの実装

### 5-1. データ構造

```typescript
export interface GameState {
    // 既存...
    
    // v0.17追加：準備システム
    preparation: PreparationState | null
    situationState: SituationState
}

export interface SituationState {
    // 治安回復
    banditIdleTurns: number           // 盗賊討伐の放置ターン数
    banditSuppressionCount: number    // 直近8ターンの討伐成功回数
    
    // 軍備増強
    equipmentIdleTurns: number        // 装備整備の放置ターン数
    trainingIdleTurns: number         // 訓練の放置ターン数
    
    // 計略
    strategyAlertLevel: number        // 敵の警戒度（0〜100）
    strategyConsecutiveCount: number  // 直近4ターンの計略実行回数
}
```

### 5-2. 準備度の更新

```typescript
function updatePreparation(
    actionType: ActionType,
    state: GameState
): void {
    // 準備行動の場合
    if (isPreparationAction(actionType)) {
        const gain = getPreparationGain(actionType)
        
        if (!state.preparation) {
            state.preparation = {
                level: 0,
                type: getTargetAction(actionType),
                turnsSpent: 0,
                maxTurns: 4,
            }
        }
        
        state.preparation.level = Math.min(100, state.preparation.level + gain)
        state.preparation.turnsSpent += 1
    }
    
    // 実行行動の場合
    if (isExecutionAction(actionType)) {
        if (state.preparation && state.preparation.type === actionType) {
            // 準備度を消費
            state.preparation.level = Math.max(0, state.preparation.level - 50)
        }
    }
    
    // 時間経過による減衰
    if (state.preparation) {
        state.preparation.level = Math.max(0, state.preparation.level - 5)
    }
}
```

### 5-3. 状況変化の更新

```typescript
function updateSituation(state: GameState): void {
    const situation = state.situationState
    
    // 治安回復：平穏度の減衰
    if (shouldTranquilityDecay(state.player.patrolStrength)) {
        state.player.tranquility = Math.max(0, state.player.tranquility - 1)
    }
    
    // 治安回復：新規盗賊の流入
    if (shouldBanditSpawn(state.player.patrolStrength)) {
        addGenericBanditCard()
    }
    
    // 軍備増強：装備の劣化
    if (situation.equipmentIdleTurns > 16) {
        degradeEquipment(state)
        situation.equipmentIdleTurns = 0
    }
    
    // 軍備増強：士気の低下
    if (situation.trainingIdleTurns > 12) {
        decreaseMorale(state)
        situation.trainingIdleTurns = 0
    }
    
    // 計略：警戒度の上昇
    if (situation.strategyConsecutiveCount >= 3) {
        situation.strategyAlertLevel = Math.min(100, situation.strategyAlertLevel + 20)
    }
    
    // 計略：警戒度の減衰
    if (situation.strategyConsecutiveCount === 0) {
        situation.strategyAlertLevel = Math.max(0, situation.strategyAlertLevel - 10)
    }
}
```

---

## 6. v0.17での実装範囲

### 6-1. 実装する

- **状況変化ロジック**：盗賊の移動・強化、装備の劣化、警戒度の上昇
- **状況変化の表示**：プレイヤーに状況変化を通知

### 6-2. 実装しない（将来拡張）

- **準備フェーズ**：v0.17では準備システムは設計のみ、実装は見送り
- **理由**：準備と実行のトレードオフが複雑すぎる、まずは状況変化で連打抑制を図る

---

## 7. 連打抑制の総合設計

v0.17では、以下の3つのメカニズムで連打抑制を実現する：

### 7-1. 命令周期と評価（主因）

- 大評定（24ターン）、月次（8ターン）、2週間（4ターン）の周期
- 下知ノルマによる評価
- **効果**：計画的な指示を促す

### 7-2. 進捗度による逓減（補助）

- 治安度・軍備充実度・計略成果が高いほど、ゲージ上昇率が低下
- **効果**：同じ方針ばかり繰り返すことへのペナルティ

### 7-3. 状況変化（補助）

- 放置や偏りへの反作用として、状況が変化
- **効果**：多様な手段を使うことを促す

---

## 8. テスト観点

### 8-1. 状況変化

- [ ] 盗賊討伐を放置すると盗賊が強化されるか
- [ ] 盗賊討伐を積極的に実行すると盗賊が減少するか
- [ ] 装備整備を放置すると装備が劣化するか
- [ ] 訓練を放置すると士気が低下するか
- [ ] 計略を連続実行すると警戒度が上昇するか

### 8-2. 状況変化の表示

- [ ] 状況変化がプレイヤーに通知されるか
- [ ] 状況変化の内容が正しく表示されるか

### 8-3. バランス

- [ ] 連打抑制が機能しているか
- [ ] 多様な手段を使うことが有利になっているか
- [ ] 状況変化が過度に厳しくないか
