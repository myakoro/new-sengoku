# v0.17 詳細設計書：04_手段（アクション）と能力の設計

## 0. 本資料の目的

- 各方針で使用可能な手段の詳細仕様を定義する
- 手段ごとの特性（リスク/コスト/能力依存/所要時間）を明確化する
- 成果計算式（基礎ゲージ量の算出方法）を整理する
- 既存コード（COMMANDS）との整合性を確保する

---

## 1. 手段の基本構造

### 1-1. 手段の定義

各手段は以下の要素で構成される：

```typescript
export interface ActionSpec {
    type: ActionType              // 手段の種類
    policy: PolicyType            // どの方針で使えるか
    baseGaugeGain: [number, number]  // 基礎ゲージ量（最小〜最大）
    cost: number                  // 実行費用（方針予算から支出）
    riskLevel: 'low' | 'medium' | 'high'  // リスクレベル
    abilityDependency: 'combat' | 'intelligence' | 'administration' | 'command'
    duration: number              // 所要ターン
    requireRank?: Rank            // 必要役職
    successRateBase?: number      // 基礎成功率（リスクがある手段のみ）
    discoveryRate?: number        // 盗賊発見率（治安回復手段のみ）
}
```

### 1-2. アプローチ（手法）の選択

各手段を実行する際、以下の3つのアプローチから1つを選択する。

| アプローチ | コスト（倍率） | 成果（倍率） | 説明 |
|------------|----------------|--------------|------|
| **愚直** | ×0 (0貫) | ×0.7 〜 1.0 | 予算を使わず、己の腕（能力）のみで遂行。高能力者ならば基礎成果を出し切れる。 |
| **並** | ×1.0 (基準) | ×1.0 〜 1.3 | 標準的な予算を投入し、部下や道具を揃える。能力の不足を補う。 |
| **豪華** | ×1.5 (1.5倍) | ×1.4 〜 1.6 | 潤沢な資金で最高の人員・機材を揃える。能力が並でも高い成果を期待できるが、高能力者が行えばさらなる相乗効果を生む。 |

### 1-3. 投資対効果（ROI）の定義

ROI = (得られたゲージ増加量) / (消費した予算)
※「愚直」は分母が0になるため、評価上は最高効率として扱う。

### 1-4. 手段の分類

手段は以下の3つの軸で分類される：

#### リスクレベル
- **low**：失敗がない、または失敗しても損失が小さい
- **medium**：失敗すると一定の損失がある
- **high**：失敗すると大きな損失がある

#### 能力依存
- **combat**：武芸能力に依存。直接的な戦闘や訓練の成果。
- **intelligence**：知略能力に依存。情報収集や計略の成功率、効率。
- **administration**：政務能力に依存。装備整備や城壁改修などの実務効率。
- **command**：統率能力に依存。人員の配置、士気の維持、集団行動の効率。

---

## 2. 治安回復の手段

### 2-1. 巡察

| 項目 | 値 |
|------|-----|
| 手段名 | 巡察 |
| 基礎ゲージ量 | 5〜10 |
| コスト | 0 |
| リスクレベル | low |
| 能力依存 | command |
| 所要ターン | 1 |
| 必要役職 | なし |

#### 説明
- 領内を巡回し、治安状況を確認する。
- 失敗がなく、安定した小幅増加（警備力ゲージへ加算）。
- **特殊効果**：一定確率（基礎30% + 警備力補正）で「盗賊」を発見し、盗賊カードを生成する。

#### 成果計算式
```typescript
// 1. アプローチ選択による倍率決定
// 愚直：cost=0, 成果倍率=random(0.7, 1.0)
// 並  ：cost=0.2, 成果倍率=random(1.0, 1.3)
// 豪華：cost=0.3, 成果倍率=random(1.4, 1.6)

// 2. ゲージ増加
baseGauge = 10 * approachMultiplier
abilityMultiplier = 0.8 + (player.command / 100) * 0.4
finalGauge = Math.floor(baseGauge * abilityMultiplier) // 警備力ゲージへ

// 3. 盗賊発見判定
discoveryRate = 30 + (player.patrolStrength * 0.5)
if (random(0, 100) < discoveryRate) {
    generateBanditCard('巡察')
}
```

#### 既存コードとの対応
- `COMMANDS.巡察` に対応（merit: 3）

### 2-2. 情報収集

| 項目 | 値 |
|------|-----|
| 手段名 | 情報収集 |
| 基礎ゲージ量（並） | 15 |
| 標準コスト（並） | 0.5 |
| リスクレベル | low |
| 能力依存 | intelligence |
| 所要ターン | 1 |
| 必要役職 | なし |

#### 説明
- 盗賊の動向や住民の声を集める。
- 知略能力が高いほど効率が良い（情報網ゲージへ加算）。
- **特殊効果**：高い確率（基礎50% + 情報網補正）で「盗賊」を発見する。発見時に盗賊の詳細情報（ランク等）が判明する。

#### 成果計算式
```typescript
// 1. アプローチ選択による倍率決定
// 愚直：cost=0, 成果倍率=random(0.7, 1.0)
// 並  ：cost=0.5, 成果倍率=random(1.0, 1.3)
// 豪華：cost=0.75, 成果倍率=random(1.4, 1.6)

// 2. ゲージ増加
baseGauge = 15 * approachMultiplier
abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
finalGauge = Math.floor(baseGauge * abilityMultiplier) // 情報網ゲージへ

// 3. 盗賊発見判定
discoveryRate = 50 + (player.intelligenceNetwork * 0.5)
if (random(0, 100) < discoveryRate) {
    generateBanditCard('情報収集', { hasDetailedInfo: true })
}
```

#### 既存コードとの対応
- `COMMANDS.情報収集` に対応（merit: 5, expGain: intelligence +10）

### 2-3. 盗賊討伐

#### 概要
- 方針期間中に「発見済み」の盗賊を掃討する。
- **実行形式**：専用の「ユニット戦闘画面」に移行して解決する。
- **報酬**：戦闘結果およびその後の「追撃フェーズ」の成果に基づき、平穏度ゲージと個別の武功（討ち取り数）が算出される。
- **戦術準備**: 戦闘開始前に「詳細偵察」「夜襲準備」等のアクションを選択可能（詳細は `05_準備システム.md` 参照）。

#### 規模別の詳細（カードのランクに依存）

##### 小規模（D級）
- 基礎ゲージ量：15〜25
- リスクレベル：medium
- 必要役職：なし
- 基礎成功率：70%

##### 中規模（C級）
- 基礎ゲージ量：25〜40
- リスクレベル：medium
- 必要役職：なし
- 基礎成功率：60%

##### 大規模（B級）
- 基礎ゲージ量：40〜60
- リスクレベル：high
- 必要役職：馬上衆
- 基礎成功率：50%

##### 討伐戦（A級）
- 基礎ゲージ量：60〜80
- リスクレベル：high
- 必要役職：馬上衆
- 基礎成功率：40%

##### 賊軍（S級）
- 基礎ゲージ量：80〜100
- リスクレベル：high
- 必要役職：小頭
- 基礎成功率：30%

#### 成果計算
盗賊討伐は確率計算ではなく、**「ユニット戦闘」の結果**によって最終的な成果が決定されます。

1.  **戦闘結果**: 敵を敗走させた（士気を0にした）時点で基本成功となる。
2.  **追撃成果**: 敗走する敵に対し、部隊全体で追撃を行う。
    - 地形調査等の準備状況や、馬の有無、疲労度が討ち取り数に影響する。
    - **個別武功**: 本人の武芸や機動力に基づき、最終的な「討ち取り数」が確定する。
3.  **ゲージ反映**: 討伐した敵の規模と殲滅率に応じ、平穏度ゲージへ還元される。

※計算ロジックの詳細は `05_準備システム.md` の「追撃・討ち取りシステム」を参照。

#### 既存コードとの対応
- `COMMANDS['盗賊討伐（小規模）']` 〜 `COMMANDS['盗賊討伐（賊軍）']` に対応
- `BANDIT_RANKS` の設定を流用

---

## 3. 軍備増強の手段

### 3-1. 訓練

| 項目 | 値 |
|------|-----|
| 手段名 | 訓練 |
| 基礎ゲージ量 | 10〜20 |
| コスト | 0 |
| リスクレベル | low |
| 能力依存 | combat |
| 所要ターン | 1 |
| 必要役職 | なし |
| 目的ステータス | 士気 |

#### 説明
- 武芸の鍛錬を行い、足軽の士気を高める
- 安定した増加
- 訓練ゲージ100で士気+1

#### 成果計算式
```typescript
baseGauge = random(10, 20)
abilityMultiplier = 0.8 + (player.combat / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- `COMMANDS.訓練` に対応（merit: 5, expGain: combat +5）

### 3-2. 演習

| 項目 | 値 |
|------|-----|
| 手段名 | 演習 |
| 基礎ゲージ量 | 15〜25 |
| コスト | 0.5 |
| リスクレベル | low |
| 能力依存 | command |
| 所要ターン | 2 |
| 必要役職 | なし |
| 目的ステータス | 疲労上限 |

#### 説明
- 実戦形式の鍛錬を行い、疲労耐性を高める
- 統率能力が高いほど効率が良い
- 演習ゲージ100で疲労上限+1（最大120）

#### 成果計算式
```typescript
baseGauge = random(15, 25)
abilityMultiplier = 0.8 + (player.command / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 3-3. 装備整備

| 項目 | 値 |
|------|-----|
| 手段名 | 装備整備 |
| 基礎ゲージ量 | 10〜15 |
| コスト | 1.0 |
| リスクレベル | low |
| 能力依存 | administration |
| 所要ターン | 1 |
| 必要役職 | なし |
| 目的ステータス | 軍備充実度 |

#### 説明
- 既存装備を整える（維持・底上げ）
- 政務能力が高いほど効率が良い
- 装備整備ゲージ100で軍備充実度+1

#### 成果計算式
```typescript
baseGauge = random(10, 15)
abilityMultiplier = 0.8 + (player.administration / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 3-4. 城壁改修

| 項目 | 値 |
|------|-----|
| 手段名 | 城壁改修 |
| 基礎ゲージ量 | 20〜30 |
| コスト | 3.0 |
| リスクレベル | low |
| 能力依存 | administration |
| 所要ターン | 4 |
| 必要役職 | なし |
| 目的ステータス | 城防御力 |

#### 説明
- 城の守りを整える（政務寄り）
- 大きな増加だが時間とコストがかかる
- 城壁改修ゲージ100で城防御力+1

#### 成果計算式
```typescript
baseGauge = random(20, 30)
abilityMultiplier = 0.8 + (player.administration / 100) * 0.4  // 0.8〜1.2
finalGauge = Math.floor(baseGauge * abilityMultiplier)
```

#### 既存コードとの対応
- 新規追加（v0.17）

---

## 4. 計略（直列3段階フェーズの手段）

計略手法によらず、現在解放されているフェーズに応じた手段を実行する。

### 4-1. 【第1フェーズ】外縁探査
- **対象**: ターゲットの周囲の情報・噂
- **目的**: 弱点や隙を突き止め、工作の土壌を作る。
- **効果**: 「探査度」ゲージへ加算。100に達すると次フェーズ解放。

#### 成果計算式
```typescript
successRate = 80 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 60, 95)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(10, 15)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = random(5, 10)  // 失敗時も少量のゲージ
}
```

#### 既存コードとの対応
- `COMMANDS.賊軍偵察` に類似（expGain: intelligence +15）

### 4-2. 【第2フェーズ】潜行手引
- **対象**: ターゲットの側近、城門の鍵、潜入ルート
- **目的**: 内部協力者の確保や物理的な侵入経路の確立。
- **効果**: 「手引度」ゲージへ加算。100に達すると次フェーズ解放。

#### 成果計算式
```typescript
successRate = 60 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 40, 85)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(20, 30)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0  // 失敗時はゲージ増加なし
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 4-3. 【第3フェーズ】本懐工作
- **対象**: ターゲット本人、実行現場、最終契約
- **目的**: 直接交渉の完遂や火薬の仕込み等、計略の仕上げ。
- **効果**: 「成功率（%）」ゲージへ加算。**この段階でのみ「実行成功」の目がある。**

#### 成果計算式
```typescript
successRate = 55 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 35, 80)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(25, 35)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 4-4. 放火

| 項目 | 値 |
|------|-----|
| 手段名 | 放火 |
| 基礎ゲージ量 | 30〜50 |
| コスト | 2.5 |
| リスクレベル | high |
| 能力依存 | intelligence |
| 所要ターン | 4 |
| 必要役職 | 馬上衆 |
| 基礎成功率 | 45% |

#### 説明
- 敵の拠点に火を放つ
- 最高リスク・リターン
- 失敗すると費用が無駄になり、評判も下がる可能性

#### 成果計算式
```typescript
successRate = 45 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 25, 75)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(30, 50)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0
    // 将来：評判ペナルティを追加
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

### 4-5. 流言の流布

| 項目 | 値 |
|------|-----|
| 手段名 | 流言の流布 |
| 基礎ゲージ量 | 15〜25 |
| コスト | 1.0 |
| リスクレベル | medium |
| 能力依存 | intelligence |
| 所要ターン | 2 |
| 必要役職 | なし |
| 基礎成功率 | 65% |

#### 説明
- 敵の士気を下げる噂を流す
- 中程度の増加
- 失敗すると費用が無駄になる

#### 成果計算式
```typescript
successRate = 65 + (player.intelligence - 50) * 0.3
successRate = clamp(successRate, 45, 85)
success = random(0, 100) < successRate

if (success) {
    baseGauge = random(15, 25)
    abilityMultiplier = 0.8 + (player.intelligence / 100) * 0.4
    finalGauge = Math.floor(baseGauge * abilityMultiplier)
} else {
    finalGauge = 0
}
```

#### 既存コードとの対応
- 新規追加（v0.17）

---

## 5. 手段の一覧表

### 5-1. 治安回復

| 手段 | ゲージ量 | コスト | リスク | 能力依存 | 所要ターン | 目的ステ | 備考 |
|------|---------|--------|--------|---------|-----------|---------|------|
| 巡察 | 5〜10 | 0 | low | command | 1 | 警備力 | 盗賊発見あり |
| 情報収集 | 10〜20 | 0.5 | low | intelligence | 1 | 情報網 | 詳細発見あり |
| 盗賊討伐 | 変動 | 0 | 変動 | combat | 4 | 平穏度 | 要盗賊カード |

### 5-2. 軍備増強

| 手段 | ゲージ量 | コスト | リスク | 能力依存 | 所要ターン | 必要役職 | 目的ステ |
|------|---------|--------|--------|---------|-----------|---------|---------|
| 訓練 | 10〜20 | 0 | low | combat | 1 | なし | 士気 |
| 演習 | 15〜25 | 0.5 | low | command | 2 | なし | 疲労上限 |
| 装備整備 | 10〜15 | 1.0 | low | administration | 1 | なし | 軍備充実度 |
| 城壁改修 | 20〜30 | 3.0 | low | administration | 4 | なし | 城防御力 |

### 5-3. 計略

| 手段 | ゲージ量 | コスト | リスク | 能力依存 | 所要ターン | 必要役職 |
|------|---------|--------|--------|---------|-----------|---------|
| 敵情視察 | 10〜15 | 0.5 | low | intelligence | 2 | なし |
| 内通者への接触 | 20〜30 | 2.0 | medium | intelligence | 3 | なし |
| 補給路の妨害 | 25〜35 | 1.5 | medium | intelligence | 3 | なし |
| 放火 | 30〜50 | 2.5 | high | intelligence | 4 | 馬上衆 |
| 流言の流布 | 15〜25 | 1.0 | medium | intelligence | 2 | なし |

---

## 6. 実装上の注意点

### 6-1. 定数の追加（constants/game.ts）

```typescript
// 手段の特性
export const ACTION_SPECS: Record<ActionType, ActionSpec> = {
    // 治安回復
    '巡察': {
        type: '巡察',
        policy: '治安回復',
        baseGaugeGain: [5, 10],
        cost: 0,
        riskLevel: 'low',
        abilityDependency: 'command',
        duration: 1,
    },
    '情報収集': {
        type: '情報収集',
        policy: '治安回復',
        baseGaugeGain: [10, 20],
        cost: 0.5,
        riskLevel: 'low',
        abilityDependency: 'intelligence',
        duration: 1,
    },
    // ... 他の手段も同様に定義
}

// 能力補正の計算
export function getAbilityMultiplier(
    player: PlayerState,
    abilityType: 'combat' | 'intelligence' | 'administration' | 'command'
): number {
    const abilityValue = player.stats[abilityType]
    return 0.8 + (abilityValue / 100) * 0.4  // 0.8〜1.2
}
```

### 6-2. ゲージ加算処理の実装

```typescript
// 手段を実行してゲージを加算
function executeAction(
    actionType: ActionType,
    player: PlayerState,
    state: GameState
): void {
    const spec = ACTION_SPECS[actionType]
    
    // コストを方針予算から支出
    if (state.currentPolicy.budget < spec.cost) {
        // エラー処理（予算不足）
        return
    }
    state.currentPolicy.budget -= spec.cost
    
    // 成功判定（リスクがある手段のみ）
    let success = true
    if (spec.successRateBase !== undefined) {
        const successRate = calculateSuccessRate(spec, player)
        success = Math.random() * 100 < successRate
    }
    
    // 基礎ゲージ量を決定
    let baseGauge = 0
    if (success) {
        baseGauge = randomInt(spec.baseGaugeGain[0], spec.baseGaugeGain[1])
    } else {
        // 失敗時の処理（手段により異なる）
        baseGauge = getFailureGauge(actionType)
    }
    
    // 能力補正を適用
    const abilityMultiplier = getAbilityMultiplier(player, spec.abilityDependency)
    const finalGauge = Math.floor(baseGauge * abilityMultiplier)
    
    // 進捗度による逓減倍率を適用（03_進捗ゲージ.md参照）
    const progressMultiplier = getGaugeMultiplier(
        state.currentPolicy.progress,
        POLICY_CONFIG[state.currentPolicy.type].gaugeMultiplierTable
    )
    const adjustedGauge = Math.floor(finalGauge * progressMultiplier)
    
    // 手段ゲージに加算
    addMeansGauge(actionType, adjustedGauge, state)
}
```

### 6-3. 既存COMMANDSとの統合

既存の `COMMANDS` は維持しつつ、v0.17では `ACTION_SPECS` を優先的に使用する。

```typescript
// 既存のCOMMANDSから手段情報を取得する互換関数
function getActionFromCommand(commandType: CommandType): ActionSpec | null {
    // v0.17の手段として定義されている場合
    if (ACTION_SPECS[commandType]) {
        return ACTION_SPECS[commandType]
    }
    
    // 既存のCOMMANDSから変換
    const command = COMMANDS[commandType]
    if (!command) return null
    
    // COMMANDSの情報をActionSpecに変換
    return convertCommandToAction(command)
}
```

---

## 7. 将来拡張（v0.18以降）

### 7-1. 手段の追加

- **募兵**：人脈・供給システム実装後に追加
- **装備調達**：人脈・供給システム実装後に追加
- **外交工作**：外交システム実装後に追加

### 7-2. 手段の組み合わせ

- 複数の手段を組み合わせることで、相乗効果を発揮
- 例：情報収集 → 盗賊討伐で成功率アップ

### 7-3. 手段の熟練度

- 同じ手段を繰り返すことで、熟練度が上がり効率が向上
- ただし、逓減メカニズムとのバランスが必要

---

## 8. テスト観点

### 8-1. 手段の実行

- [ ] 各手段が正しく実行されるか
- [ ] コストが正しく支払われるか
- [ ] 必要役職のチェックが機能するか

### 8-2. ゲージ加算

- [ ] 基礎ゲージ量が正しく計算されるか
- [ ] 能力補正が正しく適用されるか
- [ ] 進捗度による逓減倍率が正しく適用されるか

### 8-3. 成功判定

- [ ] リスクのある手段で成功判定が機能するか
- [ ] 失敗時の処理が正しく動作するか
- [ ] 成功率の計算が正しいか

### 8-4. 既存コードとの整合性

- [ ] 既存のCOMMANDSとの互換性が保たれているか
- [ ] 盗賊討伐の戦闘システムが正しく動作するか
- [ ] 経験値獲得が正しく機能するか
