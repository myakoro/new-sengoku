# v0.17 詳細設計書：09_ユニット戦闘システム

## 0. 本資料の目的

- 24ターンの時間軸を「準備」と「交戦」にシームレスに配分する仕組みを定義する
- プレイヤーの能力（特に統率）が戦闘結果に与える影響を強化する
- 戦闘終了後の「追撃フェーズ」への接続を明確にする
- 視覚的なレイアウト（手前・奥の概念）を定義する

---

## 1. ユニット戦闘の基本構造

### 1-1. 24ターンの時間軸
盗賊討伐の下知を受けると、専用の戦闘画面に移行する。この画面では最大24ターンが与えられる。

- **準備アクション**: 最初の数ターンを消費して実行。敵情報の開示やバフを得る。
- **実交戦**: 準備を終えた（あるいは準備を切り上げた）時点で「突撃・接敵」し、ターンベースの戦術バトルを行う。
- **追撃**: 実交戦で敵士気を0にする、あるいは敵が敗走した際に、残りのターンを使用して「討ち取り」を最大化する。

### 1-2. 能力の反映

| 能力 | 戦闘への影響 |
|------|-------------|
| **統率 (Command)** | **部隊全体のバフ・デバフ**。最大5名の前線ユニットの連携、士気の維持、交代の効率に影響。 |
| **武芸 (Combat)** | **個体ダメージ・防御力**。ユニット単体の殺傷能力と、自身の被ダメージ抑制。 |
| **知略 (Intelligence)** | **準備アクションの効率**。偵察の成功率や、夜襲の発見されにくさに影響。 |

> [!IMPORTANT]
> **「統率」の価値向上**: v0.17では、主人公の統率が高いほど、前線ユニット全員の攻撃・防御に 統率/100 ベースのボーナスが付与される。

---

## 2. 視覚的レイアウトの刷新

### 2-1. 疑似3D/レイヤー構造
UI上での「遠近感」を表現し、より臨場感を高める。

```text
[ 奥：敵勢力 ]
( ランクに応じた背景：山賊の砦 / 森 / 街道 )
- 敵前線ユニット (最大5)
- 敵控え (人数のみ表示、あるいは小アイコン)

      ↑
      | (交戦距離)
      ↓

[ 手前：自軍 ]
- 自軍前線ユニット (最大5) ：大きく表示、ステータス詳細
- 自軍控え (最大8) ：足元、または画面端に縮小表示
```

---

## 3. 戦術準備と実交戦のフロー

### 3-1. 準備ステップ (任意ターンの消費)
戦闘開始直後、以下のメニューから選択。1回選ぶごとにターンが経過する。

1. **地形調査 (2T)**: 敵の退路を把握。追撃効率+25%。
2. **詳細偵察 (3T)**: 敵の種類、配置、弱点が完全判明。
3. **夜襲準備 (4T)**: 成功すれば敵士気-30、先制攻撃。失敗すれば逆襲を受ける。
4. **即時突撃 (0T)**: 準備をせずに交戦開始。

### 3-2. 実交戦ステップ (ターン進行)
敵と味方が向かい合い、1ターンごとにダメージを計算。

- **スタンス選択**: 攻撃（ダメージ増/疲労増）、平常、防御（ダメージ減/疲労減）。
- **統率コマンド (NEW)**: 主人公の統率を使用し、前線のユニットに「鼓舞（士気回復）」や「死守（被ダメ大幅減）」を下す。
- **交代**: 疲労が溜まったユニットを早めに下げ、控えを出すタイミングが重要。

---

## 4. 追撃への接続

戦闘が以下の条件で終了すると、「追撃フェーズ」へ移行する。

- **勝利条件**: 敵前線の全滅、または敵全体の平均士気が0以下。
- **敗北条件**: 自軍前線の全滅、または自軍全体の平均士気が0以下（この場合、追撃は発生しない）。
- **時間切れ**: 24ターン経過。勝敗がつかない場合は「引き分け」。

### 勝利時のボーナス計算
残りのターン数（24 - 経過ターン）が多いほど、追撃の精度が上がる（＝準備不足・苦戦した場合は追撃の時間が足りない）。

```typescript
追撃残り補正 = clamp(残りターン / 12, 0.5, 1.2)
最終追撃効率 = 合計追撃効率(05_準備システム定義) × 追撃残り補正
```

---

## 5. テスト・バランス調整項目

- [ ] 統率が低いプレイヤーが「豪華」アプローチで兵を揃えても、統率の低さ（デバフ）で苦戦するバランスになっているか。
- [ ] 24ターンをすべて準備に使うと、戦闘時間が足りなくなり「引き分け（逃げられる）」リスクが生まれているか。
- [ ] UIレイアウト変更により、敵味方の区別と戦況（どちらが押しているか）が直感的に理解できるか。
