# v0.17 詳細設計書：08_ログ・UI改善

## 0. 本資料の目的

- 行動理由/結果理由のログ出力を設計する
- 進捗ゲージのデザインを整理する
- 命令伝達の表示デザインを定義する

---

## 1. ログ改善

### 1-1. 現状の問題点

v0.15のログは、行動の結果のみを表示しており、**なぜその行動を選んだのか**が分からない：

```
ターン5：盗賊討伐（中規模）を実行
→ 成功！功績+30
```

### 1-2. 改善方針

行動の**理由**と**結果の詳細**を表示する：

```
ターン5：盗賊討伐（中規模）を実行
理由：治安回復の方針を進めるため
→ 成功！治安度+1（40→41）、功績+30
→ 訓練ゲージ+25（進捗度による倍率×1.5適用）
```

### 1-3. ログの構造

```typescript
export interface ActionLog {
    turn: number                    // ターン数
    actionType: ActionType          // 行動の種類
    reason: string                  // 行動の理由
    result: ActionResult            // 結果
    details: string[]               // 詳細情報
}

export interface ActionResult {
    success: boolean                // 成功/失敗
    gaugeGain: number               // ゲージ増加量
    progressGain: number            // 進捗増加量
    meritGain: number               // 功績増加量
    expGain: Record<string, number> // 経験値増加量
}
```

### 1-4. ログの例

#### 例1：訓練
```
ターン3：訓練を実行
理由：軍備増強の方針を進めるため（目標：士気+1）
→ 成功！訓練ゲージ+15、功績+5
→ 武芸経験値+5
```

#### 例2：盗賊討伐（成功）
```
ターン7：盗賊討伐（中規模）を実行
理由：治安回復の方針を進めるため（目標：治安度60以上）
→ 成功！盗賊討伐ゲージ+30（進捗度による倍率×1.5適用）
→ 治安度+1（40→41）、功績+30
→ 武芸経験値+20
```

#### 例3：盗賊討伐（失敗）
```
ターン11：盗賊討伐（大規模）を実行
理由：治安回復の方針を進めるため（目標：治安度60以上）
→ 失敗...敵の戦闘力が高すぎた
→ ゲージ増加なし、功績+0
→ 武芸経験値+5（失敗時も少量獲得）
```

#### 例4：情報収集
```
ターン2：情報収集を実行
理由：治安回復の方針を進めるため（目標：治安度60以上）
→ 成功！情報収集ゲージ+15（知略補正×1.1適用）
→ 知略経験値+10
```

---

## 2. 進捗ゲージのデザイン

### 2-1. 表示位置

MainScreen の上部に、現在の方針と進捗ゲージを表示：

```
┌─────────────────────────────────────┐
│ 現在の方針：治安回復                │
│ 期限：ターン13まで（残り8ターン）   │
│                                     │
│ 治安度：41 / 60（最低目標）         │
│ ■■■■■■■□□□□□□□□ 41%    │
│                                     │
│ 手段ゲージ（盗賊討伐）：25 / 100    │
│ ■■□□□□□□□□ 25%              │
└─────────────────────────────────────┘
```

### 2-2. ゲージの色分け

進捗度に応じて、ゲージの色を変える：

| 進捗度 | 色 | 説明 |
|--------|-----|------|
| 0〜39% | 赤 | 目標未達の危険 |
| 40〜59% | 黄 | 最低目標に近い |
| 60〜79% | 緑 | 最低目標達成 |
| 80〜94% | 青 | 優秀評価圏内 |
| 95〜100% | 金 | 卓越評価圏内 |

### 2-3. 目標値の表示

役職により、目標値の表示が異なる：

#### 徒士/馬上衆
```
治安度：41 / ???（目標不明）
■■■■■■■□□□□□□□□ 41%
```

#### 小頭
```
治安度：41 / 60（最低目標）
■■■■■■■□□□□□□□□ 41%

目標：60（平凡）/ 80（優秀）/ 95（卓越）
```

---

## 3. 命令伝達の表示デザイン

### 3-1. 表示位置

MainScreen の中央に、命令伝達の内容を表示：

```
┌─────────────────────────────────────┐
│ 【下知】                            │
│                                     │
│ 羽柴様より、今月は治安回復に努めよ │
│ との命があった。                    │
│                                     │
│ （小頭の場合）                      │
│ 治安数値を月末までに60まで回復させ │
│ ること。現在は40である。            │
└─────────────────────────────────────┘
```

### 3-2. 3段階の表示

役職により、表示される命令の段階が異なる：

#### 徒士/馬上衆（第3段のみ）
```
【下知】
羽柴様より、今月は治安回復に努めよとの命があった。
```

#### 小頭（第2段 + 第3段）
```
【下知】
羽柴様より、今月は治安回復に努めよとの命があった。

【詳細】
治安数値を月末までに60まで回復させること。
現在は40である。
```

#### 侍大将以上（第1段 + 第2段 + 第3段）
```
【大評定】
殿様より、今期は軍備増強に注力せよとの方針が示された。

【月次目標】
足軽士気を月末までに+1すること。

【下知】
訓練に励み、足軽の士気を高めよ。
```

---

## 4. UI改善の詳細

### 4-1. MainScreen のレイアウト

```
┌─────────────────────────────────────┐
│ 【方針と進捗】                      │
│ 現在の方針：治安回復                │
│ 期限：ターン13まで（残り8ターン）   │
│ 治安度：41 / 60（最低目標）         │
│ ■■■■■■■□□□□□□□□ 41%    │
├─────────────────────────────────────┤
│ 【下知】                            │
│ 羽柴様より、今月は治安回復に努めよ │
│ との命があった。                    │
├─────────────────────────────────────┤
│ 【状態】                            │
│ ターン：5 / 週：3                   │
│ 役職：徒士                          │
│ 功績：120 / 250（馬上衆まで）       │
│ 扶持米：1.5石 / 月                  │
│ 所持金：5.2貫                       │
│ 借金：8.0貫（月利5%）               │
├─────────────────────────────────────┤
│ 【コマンド】                        │
│ 1. 訓練                             │
│ 2. 巡察                             │
│ 3. 情報収集                         │
│ 4. 盗賊討伐                         │
│ 5. その他                           │
└─────────────────────────────────────┘
```

### 4-2. コマンド選択画面

```
┌─────────────────────────────────────┐
│ 【コマンド選択】                    │
│                                     │
│ 現在の方針：治安回復                │
│ 使用可能な手段：                    │
│                                     │
│ 1. 巡察                             │
│    ゲージ：5〜10 / コスト：0        │
│    リスク：低 / 所要：1ターン       │
│                                     │
│ 2. 情報収集                         │
│    ゲージ：10〜20 / コスト：0.5貫   │
│    リスク：低 / 所要：1ターン       │
│    能力依存：知略                   │
│                                     │
│ 3. 盗賊討伐（小規模）               │
│    ゲージ：15〜25 / コスト：0       │
│    リスク：中 / 所要：4ターン       │
│    能力依存：武芸                   │
│    成功率：70%                      │
│                                     │
│ 4. 戻る                             │
└─────────────────────────────────────┘
```

### 4-3. 評定画面

```
┌─────────────────────────────────────┐
│ 【評定】                            │
│                                     │
│ 方針：治安回復                      │
│ 期間：ターン1〜13                   │
│                                     │
│ 【達成度】                          │
│ 治安度：65 / 60（最低目標）         │
│ ■■■■■■■■■■■□□□□ 65%    │
│                                     │
│ 【評価】                            │
│ 優秀！                              │
│                                     │
│ 【報酬】                            │
│ 功績：+45（基礎30 × 倍率1.5）       │
│                                     │
│ 【上司のコメント】                  │
│ 「よくやった。期待以上の成果だ」   │
│                                     │
│ 【ライバル比較】                    │
│ あなた：65                          │
│ ライバル：60                        │
│ → ライバルをわずかに上回った       │
└─────────────────────────────────────┘
```

---

## 5. 実装

### 5-1. ログ出力

```typescript
function logAction(
    turn: number,
    actionType: ActionType,
    reason: string,
    result: ActionResult
): void {
    const log: ActionLog = {
        turn,
        actionType,
        reason,
        result,
        details: generateDetails(result),
    }
    
    // ログに追加
    gameState.logs.push(log)
    
    // コンソールに出力
    console.log(`ターン${turn}：${actionType}を実行`)
    console.log(`理由：${reason}`)
    console.log(`→ ${result.success ? '成功！' : '失敗...'}`)
    log.details.forEach(detail => console.log(`→ ${detail}`))
}

function generateDetails(result: ActionResult): string[] {
    const details: string[] = []
    
    if (result.gaugeGain > 0) {
        details.push(`ゲージ+${result.gaugeGain}`)
    }
    
    if (result.progressGain > 0) {
        details.push(`進捗+${result.progressGain}`)
    }
    
    if (result.meritGain > 0) {
        details.push(`功績+${result.meritGain}`)
    }
    
    Object.entries(result.expGain).forEach(([stat, gain]) => {
        details.push(`${stat}経験値+${gain}`)
    })
    
    return details
}
```

### 5-2. 進捗ゲージの表示

```typescript
function renderProgressGauge(
    current: number,
    target: number,
    showTarget: boolean
): JSX.Element {
    const percentage = Math.min(100, (current / target) * 100)
    const color = getGaugeColor(percentage)
    
    return (
        <div className="progress-gauge">
            <div className="progress-label">
                {current} / {showTarget ? target : '???'}
            </div>
            <div className="progress-bar">
                <div 
                    className={`progress-fill ${color}`}
                    style={{ width: `${percentage}%` }}
                />
            </div>
            <div className="progress-percentage">
                {Math.floor(percentage)}%
            </div>
        </div>
    )
}

function getGaugeColor(percentage: number): string {
    if (percentage >= 95) return 'gold'
    if (percentage >= 80) return 'blue'
    if (percentage >= 60) return 'green'
    if (percentage >= 40) return 'yellow'
    return 'red'
}
```

---

## 6. テスト観点

### 6-1. ログ出力

- [ ] 行動の理由が正しく表示されるか
- [ ] 結果の詳細が正しく表示されるか
- [ ] 成功/失敗が正しく表示されるか

### 6-2. 進捗ゲージ

- [ ] 進捗度が正しく表示されるか
- [ ] ゲージの色が正しく変わるか
- [ ] 役職による目標値の表示/非表示が正しいか

### 6-3. 命令伝達

- [ ] 役職による表示内容の違いが正しいか
- [ ] 3段階の命令が正しく表示されるか

### 6-4. UI全体

- [ ] レイアウトが見やすいか
- [ ] 情報が整理されているか
- [ ] 操作しやすいか
