# v0.17 詳細設計書：03_進捗ゲージ

## 0. 本資料の目的

- 方針ゲージ（手柄評価）と手段ゲージ（進捗蓄積）の関係を明確化する
- 進捗のたまり方、減衰/逓減、効率補正の掛け方を整理する
- 各方針における「どの行動がどの手段ゲージを増やすか」「目的ステへの変換」を定義する

---

## 1. 概要：2層構造の整理

### 1-1. 方針ゲージ（手柄の目安）

- **定義**：「今期（大評定期間）にどれだけ成果を上げたか」を示す指標
- **役割**：侍大将以上の評価バロメーター（大評定出席者のみ）
- **特性**：
  - 進捗効率（ゲージの溜まりやすさ）には**影響しない**
  - 手段ゲージが加算されると、方針ゲージも同時に加算される
  - 上司が「ある地点から目標時点まで、どれくらい方針を推進したいか」を評価する指標

### 1-2. 手段ゲージ（進捗の蓄積）

- **定義**：各手段（訓練、演習、城壁改修など）の実行による進捗を蓄積するゲージ
- **役割**：目的ステータスへの変換単位（100ゲージ = 目的ステ+1）
- **特性**：
  - 倍率・逓減・効率補正が適用されるのは**手段ゲージ側のみ**
  - 手段ゲージが100に到達すると、対応する目的ステータスが+1され、ゲージは0にリセット
  - 手段ゲージの加算時に、方針ゲージも同時に加算される

### 1-3. 関係図

```
[行動実行]
    ↓
[基礎ゲージ量] ← 行動の種類・成否により決定
    ↓
[効率補正・倍率適用] ← 現在の進捗度・状況により変動
    ↓
[手段ゲージ加算] ← 100到達で目的ステ+1
    ↓
[方針ゲージ加算] ← 侍大将以上の評価指標（同時加算）
```

---

## 2. 方針ゲージと手段ゲージの関係

### 2-1. 加算ルール

手段を実行すると、以下の順序で処理される：

1. **基礎ゲージ量の決定**：行動の種類・成否により基礎値を決定
2. **効率補正・倍率の適用**：現在の進捗度・状況に応じた倍率を適用
3. **手段ゲージへの加算**：補正後の値を手段ゲージに加算
4. **方針ゲージへの加算**：手段ゲージと同じ値を方針ゲージに加算

### 2-2. 評価対象の違い

| 役職 | 手段ゲージ評価 | 方針ゲージ評価 |
|------|--------------|--------------|
| 徒士 | ○ | × |
| 馬上衆 | ○ | × |
| 小頭 | ○ | × |
| 組頭 | ○ | × |
| 足軽大将 | ○ | × |
| 侍大将 | ○ | ○ |
| 部将 | ○ | ○ |
| 家老 | ○ | ○ |

---

## 3. 手段ゲージの構造（方針別）

### 3-1. 治安回復

| 手段 | 手段ゲージ名 | 目的ステータス | 備考 |
|------|------------|--------------|------|
| 巡察 | 巡察ゲージ | 治安度 | 低リスク・低リターン |
| 情報収集 | 情報収集ゲージ | 治安度 | 中リスク・中リターン |
| 盗賊討伐 | 盗賊討伐ゲージ | 治安度 | 高リスク・高リターン |

- **方針ゲージ**：治安回復ゲージ（侍大将以上の評価指標）
- **目的ステータス**：治安度（0〜100）

### 3-2. 軍備増強

| 手段 | 手段ゲージ名 | 目的ステータス | 上限 | 備考 |
|------|------------|--------------|------|------|
| 訓練 | 訓練ゲージ | 士気 | 100 | 新規恒久ステ |
| 演習 | 演習ゲージ | 疲労上限 | 120 | 新規恒久ステ（初期100） |
| 装備整備 | 装備整備ゲージ | 軍備充実度 | 100 | v0.17では軍備充実度に寄与 |
| 城壁改修 | 城壁改修ゲージ | 城防御力 | - | 城の恒久ステ |

- **方針ゲージ**：軍備増強ゲージ（侍大将以上の評価指標）
- **目的ステータス**：各手段により異なる

### 3-3. 計略

| 手段 | 手段ゲージ名 | 目的ステータス | 備考 |
|------|------------|--------------|------|
| 敵情視察 | 敵情視察ゲージ | 計略成果 | 低リスク・低リターン |
| 内通者への接触 | 内通者接触ゲージ | 計略成果 | 中リスク・中リターン |
| 補給路の妨害 | 補給路妨害ゲージ | 計略成果 | 中リスク・中リターン |
| 放火 | 放火ゲージ | 計略成果 | 高リスク・高リターン |
| 流言の流布 | 流言流布ゲージ | 計略成果 | 中リスク・中リターン |

- **方針ゲージ**：計略ゲージ（侍大将以上の評価指標）
- **目的ステータス**：計略成果（0〜100）

---

## 4. 進捗の蓄積ルール

### 4-1. 基礎ゲージ量

各行動の基礎ゲージ量は、行動の種類と成否により決定される。

#### 治安回復の例

| 行動 | 成功時 | 失敗時 | 備考 |
|------|--------|--------|------|
| 巡察 | 5〜10 | 2〜5 | 安定した小幅増加 |
| 情報収集 | 10〜20 | 5〜10 | 中程度の増加 |
| 盗賊討伐（小規模） | 15〜25 | 0〜5 | リスク・リターン中 |
| 盗賊討伐（中規模） | 25〜40 | 0〜10 | リスク・リターン高 |
| 盗賊討伐（大規模） | 40〜60 | 0〜15 | 最高リスク・リターン |

#### 軍備増強の例

| 行動 | 基礎ゲージ量 | 備考 |
|------|------------|------|
| 訓練 | 10〜20 | 安定した増加 |
| 演習 | 15〜25 | 中程度の増加 |
| 装備整備 | 10〜15 | 安定した増加 |
| 城壁改修 | 20〜30 | 大きな増加だが時間がかかる |

#### 計略の例

| 行動 | 成功時 | 失敗時 | 備考 |
|------|--------|--------|------|
| 敵情視察 | 10〜15 | 5〜10 | 安定した増加 |
| 内通者への接触 | 20〜30 | 0〜10 | リスク・リターン中 |
| 補給路の妨害 | 25〜35 | 0〜15 | リスク・リターン中 |
| 放火 | 30〜50 | 0〜20 | 最高リスク・リターン |
| 流言の流布 | 15〜25 | 5〜15 | 中程度の増加 |

### 4-2. 変換ルール（100ゲージ = 目的ステ+1）

- 手段ゲージが100に到達したら、対応する目的ステータスが+1される
- ゲージは0にリセットされる
- 余剰分は次回に繰り越される（例：ゲージ120 → 目的ステ+1、ゲージ20）

---

## 5. 減衰・逓減メカニズム

### 5-1. 基本方針

- **連打抑制の主因**：命令周期（大評定24turn/月次8turn/2週4turn）と評価システム
- **減衰/逓減の役割**：「同じ手段ばかり繰り返す」ことへの補助的なペナルティ

### 5-2. 進捗度による逓減（01_方針システム.md より）

#### 治安回復

| 治安度 | 手段ゲージ上昇率 | 理由 |
|--------|--------------|------|
| 0〜20 | ×2.0 | 治安が極めて悪い → 盗賊が多い → 討伐で大きく溜まる |
| 21〜40 | ×1.5 | 治安が悪い → 盗賊がやや多い |
| 41〜60 | ×1.0 | 治安が普通 → 標準的な溜まり方 |
| 61〜80 | ×0.7 | 治安が良い → 盗賊が少ない → 地道な巡察 |
| 81〜100 | ×0.5 | 治安が極めて良い → 盗賊がほぼいない |

#### 軍備増強

| 軍備充実度 | 手段ゲージ上昇率 | 理由 |
|-----------|--------------|------|
| 0〜30 | ×1.4 | 未整備 → 改善余地が大きい |
| 31〜60 | ×1.0 | 標準的な整備状況 |
| 61〜80 | ×0.7 | かなり整っている → 伸びしろが少ない |
| 81〜100 | ×0.5 | ほぼ完璧 → これ以上の改善は困難 |

#### 計略

| 計略成果 | 手段ゲージ上昇率 | 理由 |
|---------|--------------|------|
| 0〜10 | ×1.5 | 初動 → 成果が出やすい |
| 11〜30 | ×1.0 | 標準的な進捗 |
| 31〜60 | ×0.7 | 後半 → 同一手段では伸びにくい |
| 61〜100 | ×0.5 | 終盤 → 大幅な成果は困難 |

### 5-3. 同一手段の連続実行による逓減（将来拡張）

v0.17では実装しないが、将来的には以下のような逓減を検討：

- 同一手段を連続で実行すると、2回目以降は効率が下がる
- 例：訓練を3ターン連続で実行 → 1回目100%、2回目80%、3回目60%
- 別の手段を挟むとリセット

---

## 6. 効率補正の適用

### 6-1. 補正の種類

効率補正は、以下の要素により決定される：

1. **進捗度による逓減**（5-2参照）
2. **能力値による補正**（将来実装）
3. **装備・状態による補正**（将来実装）
4. **天候・季節による補正**（将来実装）

### 6-2. 適用順序

```
基礎ゲージ量
  ↓
× 進捗度による逓減倍率
  ↓
× 能力値補正（将来）
  ↓
× 装備・状態補正（将来）
  ↓
× 天候・季節補正（将来）
  ↓
最終ゲージ加算量
```

### 6-3. v0.17での実装範囲

- **実装する**：進捗度による逓減（5-2）
- **実装しない**：能力値補正、装備・状態補正、天候・季節補正（将来拡張として設計のみ記載）

---

## 7. 目的ステへの変換（100=+1ルール）

### 7-1. 軍備増強の目的ステータス

#### 訓練 → 士気

- **目的ステータス**：士気（morale）
- **初期値**：60（提案）
- **上限**：100
- **増加方法**：訓練ゲージ100ごとに+1
- **効果**：戦闘中の士気に影響（高いほど攻撃力・防御力が上昇）
- **実装**：PlayerStateに新規フィールド `morale: number` を追加

#### 演習 → 疲労上限

- **目的ステータス**：疲労上限（fatigueCapacity）
- **初期値**：100
- **上限**：120
- **増加方法**：演習ゲージ100ごとに+1（最大+20まで）
- **効果**：戦闘中の疲労上限が上昇（長時間戦闘が可能）
- **実装**：PlayerStateに新規フィールド `fatigueCapacity: number` を追加

#### 城壁改修 → 城防御力

- **目的ステータス**：城防御力（castleDefense）
- **初期値**：城により異なる（例：50）
- **上限**：なし（または200程度）
- **増加方法**：城壁改修ゲージ100ごとに+1
- **効果**：城攻めの際の防御力が上昇
- **実装**：城の状態に新規フィールド `defense: number` を追加（将来実装）

#### 装備整備 → 軍備充実度

- **目的ステータス**：軍備充実度（militaryReadiness）
- **初期値**：40
- **上限**：100
- **増加方法**：装備整備ゲージ100ごとに+1
- **効果**：v0.17では方針の進捗指標として機能
- **実装**：PolicyStateの `progress` として既に実装済み

### 7-2. 治安回復の目的ステータス

#### 巡察/情報収集/盗賊討伐 → 治安度

- **目的ステータス**：治安度（security）
- **初期値**：40
- **上限**：100
- **増加方法**：各手段ゲージ100ごとに+1
- **効果**：治安が高いほど盗賊の発生率が低下
- **実装**：PolicyStateの `progress` として既に実装済み

### 7-3. 計略の目的ステータス

#### 各計略手段 → 計略成果

- **目的ステータス**：計略成果（strategyProgress）
- **初期値**：0
- **上限**：100
- **増加方法**：各手段ゲージ100ごとに+1
- **効果**：計略成果が高いほど敵の弱体化が進む
- **実装**：PolicyStateの `progress` として既に実装済み

---

## 8. 各方針の手段マッピング表

### 8-1. 治安回復

| 手段 | 手段ゲージ | 目的ステ | 基礎ゲージ量 | 逓減倍率 | 備考 |
|------|----------|---------|------------|---------|------|
| 巡察 | 巡察ゲージ | 治安度 | 5〜10 | 治安度依存 | 安定した小幅増加 |
| 情報収集 | 情報収集ゲージ | 治安度 | 10〜20 | 治安度依存 | 中程度の増加 |
| 盗賊討伐 | 盗賊討伐ゲージ | 治安度 | 15〜60 | 治安度依存 | 規模により変動 |

### 8-2. 軍備増強

| 手段 | 手段ゲージ | 目的ステ | 基礎ゲージ量 | 逓減倍率 | 目的ステ上限 | 備考 |
|------|----------|---------|------------|---------|------------|------|
| 訓練 | 訓練ゲージ | 士気 | 10〜20 | 軍備充実度依存 | 100 | 新規恒久ステ |
| 演習 | 演習ゲージ | 疲労上限 | 15〜25 | 軍備充実度依存 | 120 | 新規恒久ステ（初期100） |
| 装備整備 | 装備整備ゲージ | 軍備充実度 | 10〜15 | 軍備充実度依存 | 100 | 方針進捗 |
| 城壁改修 | 城壁改修ゲージ | 城防御力 | 20〜30 | 軍備充実度依存 | - | 城の恒久ステ |

### 8-3. 計略

| 手段 | 手段ゲージ | 目的ステ | 基礎ゲージ量 | 逓減倍率 | 備考 |
|------|----------|---------|------------|---------|------|
| 敵情視察 | 敵情視察ゲージ | 計略成果 | 10〜15 | 計略成果依存 | 安定した増加 |
| 内通者への接触 | 内通者接触ゲージ | 計略成果 | 20〜30 | 計略成果依存 | リスク・リターン中 |
| 補給路の妨害 | 補給路妨害ゲージ | 計略成果 | 25〜35 | 計略成果依存 | リスク・リターン中 |
| 放火 | 放火ゲージ | 計略成果 | 30〜50 | 計略成果依存 | 最高リスク・リターン |
| 流言の流布 | 流言流布ゲージ | 計略成果 | 15〜25 | 計略成果依存 | 中程度の増加 |

---

## 9. 実装上の注意点

### 9-1. PlayerStateへの新規フィールド追加

軍備増強の目的ステータス（士気・疲労上限）を実装するため、PlayerStateに以下のフィールドを追加する必要がある：

```typescript
export interface PlayerState {
    // 既存フィールド...
    
    // v0.17追加：軍備増強の目的ステータス
    morale: number              // 士気（初期値60、上限100）
    fatigueCapacity: number     // 疲労上限（初期値100、上限120）
}
```

### 9-2. 手段ゲージの管理

各手段ゲージは、PolicyStateとは別に管理する必要がある。以下の構造を提案：

```typescript
export interface MeansGaugeState {
    // 治安回復
    patrol?: number              // 巡察ゲージ
    intelligence?: number        // 情報収集ゲージ
    banditSuppression?: number   // 盗賊討伐ゲージ
    
    // 軍備増強
    training?: number            // 訓練ゲージ
    drill?: number               // 演習ゲージ
    equipmentMaintenance?: number // 装備整備ゲージ
    wallRepair?: number          // 城壁改修ゲージ
    
    // 計略
    reconnaissance?: number      // 敵情視察ゲージ
    conspiracy?: number          // 内通者接触ゲージ
    supplyDisruption?: number    // 補給路妨害ゲージ
    arson?: number               // 放火ゲージ
    rumor?: number               // 流言流布ゲージ
}
```

### 9-3. ゲージ加算処理の実装例

```typescript
// 手段ゲージを加算し、100到達で目的ステを+1
function addMeansGauge(
    meansType: MeansType,
    baseAmount: number,
    state: GameState
): void {
    const policy = state.currentPolicy
    if (!policy || policy.status !== 'active') return
    
    // 進捗度による逓減倍率を取得
    const multiplier = getGaugeMultiplier(
        policy.progress,
        POLICY_CONFIG[policy.type].gaugeMultiplierTable
    )
    
    // 補正後のゲージ量を計算
    const actualAmount = Math.floor(baseAmount * multiplier)
    
    // 手段ゲージに加算
    const currentGauge = state.meansGauges[meansType] ?? 0
    let newGauge = currentGauge + actualAmount
    
    // 100到達で目的ステ+1
    while (newGauge >= 100) {
        incrementTargetStat(meansType, state)
        newGauge -= 100
    }
    
    // 手段ゲージを更新
    state.meansGauges[meansType] = Math.min(99, newGauge)
    
    // 方針ゲージにも同じ量を加算（侍大将以上の評価指標）
    if (state.player.rank === '侍大将' || 
        state.player.rank === '部将' || 
        state.player.rank === '家老') {
        state.currentPolicy.meritGauge = Math.min(
            100,
            state.currentPolicy.meritGauge + actualAmount
        )
    }
}

// 目的ステータスを+1
function incrementTargetStat(meansType: MeansType, state: GameState): void {
    switch (meansType) {
        case '訓練':
            state.player.morale = Math.min(100, state.player.morale + 1)
            break
        case '演習':
            state.player.fatigueCapacity = Math.min(120, state.player.fatigueCapacity + 1)
            break
        case '城壁改修':
            // 城防御力を+1（将来実装）
            break
        case '巡察':
        case '情報収集':
        case '盗賊討伐':
            state.currentPolicy.progress = Math.min(100, state.currentPolicy.progress + 1)
            break
        // 他の手段も同様...
    }
}
```

### 9-4. 初期化処理

ゲーム開始時に、新規フィールドを初期化する：

```typescript
initializeGame: (name, potential) => {
    const player: PlayerState = {
        // 既存フィールド...
        
        // v0.17追加
        morale: 60,              // 士気の初期値
        fatigueCapacity: 100,    // 疲労上限の初期値
    }
    
    const meansGauges: MeansGaugeState = {
        // すべて0で初期化
    }
    
    set({
        player,
        meansGauges,
        // ...
    })
}
```

### 9-5. セーブ/ロード対応

新規フィールドをセーブデータに含める：

```typescript
saveGame: () => {
    const state = get()
    const saveData = {
        // 既存...
        player: {
            // 既存フィールド...
            morale: state.player.morale,
            fatigueCapacity: state.player.fatigueCapacity,
        },
        meansGauges: state.meansGauges,
        // ...
    }
    // ...
}

loadGame: () => {
    // ...
    set({
        player: {
            // 既存フィールド...
            morale: saveData.player.morale ?? 60,
            fatigueCapacity: saveData.player.fatigueCapacity ?? 100,
        },
        meansGauges: saveData.meansGauges ?? {},
        // ...
    })
}
```

---

## 10. 将来拡張（v0.18以降）

### 10-1. 同一手段の連続実行による逓減

- 同一手段を連続で実行すると、効率が下がる仕組み
- 手段の多様化を促進

### 10-2. 能力値による効率補正

- 訓練：combat能力が高いほど効率が良い
- 演習：command能力が高いほど効率が良い
- 城壁改修：administration能力が高いほど効率が良い

### 10-3. 装備・状態による補正

- 良い装備を持っているほど訓練効率が上がる
- 疲労が溜まっているほど効率が下がる

### 10-4. 天候・季節による補正

- 雨天時は訓練効率が下がる
- 冬季は城壁改修が困難

---

## 11. テスト観点

### 11-1. 手段ゲージの加算

- [ ] 手段を実行すると手段ゲージが増加するか
- [ ] 進捗度による逓減倍率が正しく適用されるか
- [ ] 手段ゲージが100到達で目的ステが+1されるか
- [ ] 余剰分が次回に繰り越されるか

### 11-2. 方針ゲージの加算

- [ ] 手段ゲージ加算時に方針ゲージも加算されるか
- [ ] 侍大将以上のみ方針ゲージが加算されるか
- [ ] 方針ゲージが100を超えないか

### 11-3. 目的ステータスの更新

- [ ] 訓練ゲージ100で士気が+1されるか
- [ ] 演習ゲージ100で疲労上限が+1されるか
- [ ] 士気が100を超えないか
- [ ] 疲労上限が120を超えないか

### 11-4. セーブ/ロード

- [ ] 新規フィールドが正しく保存されるか
- [ ] 新規フィールドが正しく復元されるか
- [ ] 旧バージョンのセーブデータでもエラーが出ないか
