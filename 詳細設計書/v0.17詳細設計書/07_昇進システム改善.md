# v0.17 詳細設計書：07_昇進システム改善

## 0. 本資料の目的

- 資源制約の調整を設計する
- 借金システムとの連携を強化する
- 昇進の難易度バランスを整理する

---

## 1. 現状の問題点

### 1-1. v0.15の昇進システム

| 役職 | 必要功績 | 必要能力 | 問題点 |
|------|---------|---------|--------|
| 徒士 → 馬上衆 | 250 | combat 40 | 比較的簡単に達成可能 |
| 馬上衆 → 小頭 | 600 | combat 50 | 功績が貯まりにくい |

### 1-2. 問題点の詳細

1. **資源制約が弱い**
   - 馬の購入（8貫）が昇進の主な障壁
   - 借金システムがあるため、資金不足はあまり問題にならない

2. **昇進後の負担が大きい**
   - 馬上衆：扶持米3.5石 + 馬維持費0.6石 = 4.1石/月
   - 小頭：扶持米5.0石 + 馬維持費0.6石 = 5.6石/月
   - 家臣を雇うと更に負担増

3. **借金の返済が困難**
   - 昇進後の収入増加が負担増加に追いつかない
   - 借金を抱えたまま昇進すると、返済が困難になる

---

## 2. v0.17での改善方針

### 2-1. 基本方針

- **昇進条件は維持**：功績と能力の要件は変更しない
- **資源制約を調整**：昇進後の負担を軽減し、借金返済を容易にする
- **借金システムとの連携**：借金を抱えたまま昇進できるが、返済計画が必要

### 2-2. 具体的な改善

#### 改善1：扶持米の増額

| 役職 | v0.15 | v0.17 | 増額 |
|------|-------|-------|------|
| 徒士 | 1.2石 | 1.5石 | +0.3石 |
| 馬上衆 | 3.5石 | 4.0石 | +0.5石 |
| 小頭 | 5.0石 | 6.0石 | +1.0石 |

**理由**：昇進後の負担増加に対して、収入増加が追いつくようにする

#### 改善2：馬維持費の軽減

| 項目 | v0.15 | v0.17 |
|------|-------|-------|
| 馬維持費 | 0.6石/月 | 0.4石/月 |

**理由**：馬上衆・小頭の負担を軽減

#### 改善3：生活費の調整

| 項目 | v0.15 | v0.17 |
|------|-------|-------|
| 生活費 | 0.15石/月 | 0.1石/月 |

**理由**：全体的な負担を軽減

---

## 3. 昇進後の収支シミュレーション

### 3-1. 徒士 → 馬上衆（v0.17）

#### 昇進前（徒士）
- 収入：1.5石/月
- 支出：生活費0.1石 = 0.1石/月
- **純収入：1.4石/月**

#### 昇進後（馬上衆）
- 収入：4.0石/月
- 支出：生活費0.1石 + 馬維持費0.4石 = 0.5石/月
- **純収入：3.5石/月**

**増加分：+2.1石/月**

### 3-2. 馬上衆 → 小頭（v0.17）

#### 昇進前（馬上衆）
- 収入：4.0石/月
- 支出：生活費0.1石 + 馬維持費0.4石 = 0.5石/月
- **純収入：3.5石/月**

#### 昇進後（小頭）
- 収入：6.0石/月
- 支出：生活費0.1石 + 馬維持費0.4石 = 0.5石/月
- **純収入：5.5石/月**

**増加分：+2.0石/月**

### 3-3. 家臣を雇った場合（小頭）

#### 若党2人を雇用
- 収入：6.0石/月
- 支出：生活費0.1石 + 馬維持費0.4石 + 若党2人×0.3石 = 1.1石/月
- **純収入：4.9石/月**

**家臣なしと比較：-0.6石/月**

---

## 4. 借金システムとの連携

### 4-1. 借金の返済計画

昇進時に借金を抱えている場合、返済計画を立てる必要がある：

#### 例：馬購入のために8貫借金（月利5%）

| 月 | 借金残高 | 利息 | 返済額 | 純収入 | 備考 |
|----|---------|------|--------|--------|------|
| 1 | 8.0貫 | 0.4貫 | 2.0貫 | 1.5石 | 徒士 |
| 2 | 6.4貫 | 0.32貫 | 2.0貫 | 1.18石 | |
| 3 | 4.72貫 | 0.24貫 | 2.0貫 | 1.26石 | |
| 4 | 2.96貫 | 0.15貫 | 2.0貫 | 1.35石 | |
| 5 | 1.11貫 | 0.06貫 | 1.17貫 | 2.33石 | 完済 |

**返済期間：5ヶ月**

### 4-2. 借金限度額の調整

| 役職 | v0.15 | v0.17 | 理由 |
|------|-------|-------|------|
| 徒士 | 14.4貫 | 18.0貫 | 扶持米増額に伴い増加 |
| 馬上衆 | 42貫 | 48貫 | 扶持米増額に伴い増加 |
| 小頭 | 60貫 | 72貫 | 扶持米増額に伴い増加 |

**計算式**：年収（扶持米×12ヶ月）

---

## 5. 昇進イベントの改善

### 5-1. 昇進時の選択肢

昇進時に、以下の選択肢を提示する：

#### 選択肢1：即座に昇進
- 馬を購入し、すぐに昇進
- 借金を抱える可能性がある

#### 選択肢2：資金を貯めてから昇進
- 馬購入資金（8貫）を貯めてから昇進
- 借金を避けられる

#### 選択肢3：昇進を見送る
- 功績は達成しているが、昇進しない
- 資金に余裕ができるまで待つ

### 5-2. 昇進時のアドバイス

昇進時に、上司からアドバイスを受ける：

#### 借金がある場合
- 「借金を抱えたまま昇進するのは危険だ。返済計画を立てよ」
- 「馬の維持費も馬鹿にならん。慎重に考えよ」

#### 借金がない場合
- 「よくぞここまで来た。馬上衆としての務めを果たせ」
- 「馬を手に入れれば、更なる活躍が期待できる」

---

## 6. 実装

### 6-1. 定数の更新

```typescript
// 扶持米（月額）
export const SALARY_RICE: Record<Rank, number> = {
    徒士: 1.5,    // v0.15: 1.2
    馬上衆: 4.0,  // v0.15: 3.5
    小頭: 6.0,    // v0.15: 5.0
}

// その他支出
export const LIVING_COST = 0.1  // v0.15: 0.15
export const HORSE_COST = 0.4   // v0.15: 0.6

// 借金上限（年収相当）
export const DEBT_LIMIT: Record<Rank, number> = {
    徒士: 18.0,    // 1.5石×12ヶ月
    馬上衆: 48.0,  // 4.0石×12ヶ月
    小頭: 72.0,    // 6.0石×12ヶ月
}
```

### 6-2. 昇進時の処理

```typescript
function checkPromotion(player: PlayerState): PromotionResult | null {
    // 功績と能力の要件チェック（既存）
    if (player.rank === '徒士' && 
        player.merit >= 250 && 
        player.stats.combat >= 40) {
        
        // 馬を持っているかチェック
        if (!player.hasHorse) {
            return {
                eligible: true,
                nextRank: '馬上衆',
                requiresHorse: true,
                horseCost: PURCHASE_COSTS.馬,
                canAfford: player.money >= PURCHASE_COSTS.馬,
                debtWarning: player.debt > 0,
            }
        } else {
            return {
                eligible: true,
                nextRank: '馬上衆',
                requiresHorse: false,
            }
        }
    }
    
    // 馬上衆 → 小頭の判定も同様
    
    return null
}
```

---

## 7. バランス調整の指針

### 7-1. 目標

- **徒士期間**：3〜6ヶ月（12〜24ターン）
- **馬上衆期間**：6〜12ヶ月（24〜48ターン）
- **小頭到達**：9〜18ヶ月（36〜72ターン）

### 7-2. 調整パラメータ

| パラメータ | 現在値 | 調整方向 | 理由 |
|-----------|--------|---------|------|
| 扶持米 | 1.5/4.0/6.0 | 適切 | 昇進後の負担に対応 |
| 馬維持費 | 0.4 | 適切 | 負担軽減 |
| 生活費 | 0.1 | 適切 | 全体的な負担軽減 |
| 借金限度額 | 18/48/72 | 適切 | 年収相当 |

---

## 8. テスト観点

### 8-1. 昇進条件

- [ ] 功績と能力の要件が正しくチェックされるか
- [ ] 馬の所持が正しくチェックされるか

### 8-2. 収支バランス

- [ ] 昇進後の純収入が増加するか
- [ ] 借金の返済が可能な範囲か
- [ ] 家臣を雇っても破綻しないか

### 8-3. 昇進イベント

- [ ] 昇進時の選択肢が正しく表示されるか
- [ ] 借金がある場合、警告が表示されるか
- [ ] 昇進を見送ることができるか

### 8-4. 借金システム

- [ ] 借金限度額が正しく更新されるか
- [ ] 利息が正しく計算されるか
- [ ] 返済が正しく処理されるか
